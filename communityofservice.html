<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ATLANTIS CORP: MODERATOR CONTROL</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e0e0e0;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .chat-container {
            height: 300px;
            overflow-y: auto;
        }
        .chat-message {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        /* Custom styles for nested progress bars */
        .nested-progress-container {
            margin-left: 1rem;
            border-left: 2px solid #e0e0e0;
            padding-left: 1rem;
        }
        .department-item, .subdivision-item {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .task-item {
            background-color: #ffffff;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50">
<!-- Firebase Configuration -->
<script>
	const firebaseConfig = {
  		apiKey: "AIzaSyCdl3XJ-eUz8BELLaSOXeZFpg7FLDFk7l4",
  		authDomain: "community-service-f4540.firebaseapp.com",
  		databaseURL: "https://community-service-f4540-default-rtdb.asia-southeast1.firebasedatabase.app", // ‚Üê ubah di sini!
  		projectId: "community-service-f4540",
  		storageBucket: "community-service-f4540.appspot.com",
  		messagingSenderId: "610712310542",
  		appId: "1:610712310542:web:12536a7c23d0b41db03d5f",
  		measurementId: "G-61R3Q4ZJNS"
	};


	  // ‚úÖ Tambahkan baris berikut untuk menghindari error "db is not defined"
 	 firebase.initializeApp(firebaseConfig);
  	const db = firebase.database();
  	const auth = firebase.auth();
    
</script>
<!-- Auth Modal -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="authModal">
<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
<h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">Moderator Login</h2>
<div id="loginForm">
<div class="mb-4">
<label class="block text-gray-700 mb-2">Email</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="loginEmail" type="email"/>
</div>
<div class="mb-6">
<label class="block text-gray-700 mb-2">Password</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="loginPassword" type="password"/>
</div>
<button class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition" id="loginBtn">
                    Login
                </button>
<p class="text-red-500 mt-2 text-sm hidden" id="loginError"></p>
</div>
<div class="hidden" id="profileForm">
<h3 class="text-xl font-semibold text-blue-700 mb-4">Complete Your Profile</h3>
<div class="mb-4">
<label class="block text-gray-700 mb-2">Full Name</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="profileName" type="text"/>
</div>
<div class="mb-4">
<label class="block text-gray-700 mb-2">Departemen</label>

<select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="profileRole" onchange="updateSubDivisions('profileRole', 'profileSubDivision')">
  <option value="">Pilih Departemen</option>
  <option value="Founder">Founder</option>
  <option value="Co-Founder">Co-Founder</option>
  <option value="Education">Education</option>
  <option value="Moderation">Moderation</option>
  <option value="Events">Events</option>
  <option value="Creative">Creative</option>
  <option value="Technology">Technology</option>
  <option value="Finance">Finance</option>
</select>

</div>
<div class="mb-4">
<label class="block text-gray-700 mb-2">New Password</label>
<input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="profilePassword" type="password"/>
</div>
<div class="mb-4">
<label class="block text-gray-700 mb-2">Sub-Divisi</label>

<select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="profileSubDivision" disabled>
  <option value="">Pilih Sub-Divisi</option>
  <option value="Koordinator Edukasi" data-role="Education">Koordinator Edukasi</option>
<option value="Mentor" data-role="Education">Mentor</option>
<option value="Pemateri" data-role="Education">Pemateri</option>
<option value="Notulen" data-role="Education">Notulen</option>
<option value="Head Moderator" data-role="Moderation">Head Moderator</option>
<option value="Moderator" data-role="Moderation">Moderator</option>
<option value="Helper" data-role="Moderation">Helper</option>
<option value="Support Staff" data-role="Moderation">Support Staff</option>
<option value="Event Coordinator" data-role="Events">Event Coordinator</option>
<option value="MC" data-role="Events">MC</option>
<option value="Host" data-role="Events">Host</option>
<option value="Giveaway Staff" data-role="Events">Giveaway Staff</option>
<option value="Content Lead" data-role="Creative">Content Lead</option>
<option value="Designer" data-role="Creative">Designer</option>
<option value="Editor" data-role="Creative">Editor</option>
<option value="Dokumentator" data-role="Creative">Dokumentator</option>
<option value="Social Media" data-role="Creative">Social Media</option>
<option value="Tech Lead" data-role="Technology">Tech Lead</option>
<option value="Bot Developer" data-role="Technology">Bot Developer</option>
<option value="Web Tools Support" data-role="Technology">Web Tools Support</option>
<option value="Database Admin" data-role="Technology">Database Admin</option>
<option value="Bendahara" data-role="Finance">Bendahara</option>
<option value="Pembukuan" data-role="Finance">Pembukuan</option>
<option value="Donasi" data-role="Finance">Donasi</option>
<option value="Anggaran" data-role="Finance">Anggaran</option>
<option value="Laporan Keuangan" data-role="Finance">Laporan Keuangan</option>

</select>

</div><button class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition" id="saveProfileBtn">
                    Save Profile
                </button>
</div>
</div>
</div>
<!-- Main App -->
<div class="hidden" id="app">
<!-- Header -->
<header class="bg-white shadow-sm">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
<div class="flex items-center">
<div class="bg-blue-600 text-white font-bold rounded-lg p-2 mr-3">
                        MRI
                    </div>
<h1 class="text-xl font-bold text-gray-800">ATLANTIS CORP : MODERATOR CONTROL</h1>
</div>
<div class="flex items-center space-x-4">
<div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold cursor-pointer" id="userAvatar"></div>
<button class="text-gray-600 hover:text-gray-900" id="logoutBtn">
<svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
</div>
</header>
<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<div class="flex flex-col md:flex-row gap-8">
<!-- Sidebar -->
<div class="md:w-1/4 mb-8 md:mb-0">
<nav class="space-y-1">
<button class="tab-btn w-full text-left px-3 py-2 rounded-md bg-blue-100 text-blue-800 font-medium" id="moderatorsTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                Moderators
                            </div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" id="eventsTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                Events
                            </div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" id="reportsTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                Reports
                            </div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" id="chatTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                Chat Room
                            </div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" id="financeTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                Finance
                            </div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" id="profileTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                My Profile
                            </div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" onclick="window.open('https://discord.gg/pVBzxPKJjw', '_blank')">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
Discord Server
</div>
</button>
<button class="tab-btn w-full text-left px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100" id="ticketingTab">
<div class="flex items-center">
<svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 17v-6h13v6H9zM4 7h16V5H4v2zm0 4h16V9H4v2zm0 4h16v-2H4v2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
    Tiketing
  </div>
</button>
</nav>
<div class="mt-8 p-4 bg-white shadow rounded-lg">
<h3 class="font-medium text-gray-900 mb-2">Quick Stats</h3>
<div class="flex justify-between items-center mb-2">
<span class="text-sm text-gray-500">Moderators:</span>
<span class="font-medium" id="moderatorCount">0</span>
</div>
<div class="flex justify-between items-center mb-2">
<span class="text-sm text-gray-500">Active Events:</span>
<span class="font-medium" id="activeEventCount">0</span>
</div>
<div class="flex justify-between items-center mb-2">
<span class="text-sm text-gray-500">Pending Reports:</span>
<span class="font-medium" id="pendingReportCount">0</span>
</div>
</div>
</div>
<!-- Content Area -->
<div class="md:w-3/4">
<!-- Moderators Content -->
<div class="content-section" id="moderatorsContent">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-800">Moderator Team</h2>
<div class="relative">
<input class="pl-8 pr-4 py-2 border border-gray-300 rounded-md" id="moderatorSearch" placeholder="Search moderators..." type="text"/>
<svg class="h-5 w-5 absolute left-2 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</div>
</div>
<div class="space-y-4" id="moderatorsList">
<!-- Moderators will be loaded here -->
<div class="flex items-center justify-center py-12">
<div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
</div>
</div>
</div>
<!-- Events Content -->
<div class="content-section hidden" id="eventsContent">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-800">Community Events</h2>
<button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center" id="addEventBtn">
<svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                Add Event
                            </button>
</div>
<div class="space-y-4" id="eventsList">
<!-- Events will be loaded here -->
<div class="flex items-center justify-center py-12">
<div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
</div>
</div>
</div>
<!-- Reports Content -->
<div class="content-section hidden" id="reportsContent">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-800">Server Reports</h2>
<div class="flex space-x-2">
<select class="border border-gray-300 rounded-md px-3 py-2" id="reportFilter">
<option value="all">All Reports</option>
<option value="pending">Pending</option>
<option value="resolved">Resolved</option>
<option value="ignored">Ignored</option>
</select>
<button class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center" id="addReportBtn">
<svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                    New Report
                                </button>
</div>
</div>
<div class="space-y-4" id="reportsList">
<!-- Reports will be loaded here -->
<div class="flex items-center justify-center py-12">
<div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
</div>
</div>
</div>
<!-- Chat Content -->
<div class="content-section hidden" id="chatContent">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-800">Community Chat</h2>
<div class="text-sm text-gray-500">
<span id="onlineCount">0</span> moderators online
                            </div>
</div>
<div class="chat-container bg-white p-4 rounded-lg shadow mb-4" id="chatMessages">
<!-- Messages will be loaded here -->
<div class="text-center py-8 text-gray-500">
                                Loading chat history...
                            </div>
</div>
<div class="flex space-x-2">
<input class="flex-1 border border-gray-300 rounded-md px-4 py-2" id="chatInput" placeholder="Type your message..." type="text"/>
<button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" id="sendChatBtn">
                                Send
                            </button>
</div>
</div>
<!-- Finance Content -->
<div class="content-section hidden" id="financeContent">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-800">Financial Dashboard</h2>
<div class="flex space-x-2">
<button class="border border-gray-300 px-4 py-2 rounded-md hover:bg-gray-100 flex items-center" id="exportFinanceBtn">
<svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                    Export
                                </button>
<button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center" id="addTransactionBtn">
<svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
                                    Add Transaction
                                </button>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="bg-white p-4 shadow rounded-lg">
<h3 class="text-sm font-medium text-gray-500">Total Balance</h3>
<p class="text-2xl font-semibold text-gray-900" id="totalBalance">Rp 0</p>
</div>
<div class="bg-white p-4 shadow rounded-lg">
<h3 class="text-sm font-medium text-gray-500">Monthly Income</h3>
<p class="text-2xl font-semibold text-green-600" id="monthlyIncome">Rp 0</p>
</div>
<div class="bg-white p-4 shadow rounded-lg">
<h3 class="text-sm font-medium text-gray-500">Monthly Expenses</h3>
<p class="text-2xl font-semibold text-red-600" id="monthlyExpenses">Rp 0</p>
</div>
</div>
<div class="space-y-2" id="transactionsList">
<!-- Transactions will be loaded here -->
<div class="flex items-center justify-center py-12">
<div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
</div>
</div>
</div>
<!-- Ticketing Content -->
<div class="content-section hidden" id="ticketingContent">
<div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6">
<h1 class="text-2xl font-bold text-center mb-6">üé´ Ticket Purchase Form</h1>
<form class="space-y-4" id="ticketForm">
<input class="w-full p-2 border rounded" id="buyerName" placeholder="Buyer Name" required="" type="text"/>
<select class="w-full p-2 border rounded" id="category" required="">
<option value="">Select Category</option>
<option value="Income">Income</option>
<option value="Expense">Expense</option>
</select>
<select class="w-full p-2 border rounded" disabled="" id="ticketType" required="">
<option value="">-- Select Category First --</option>
</select>
<input class="w-full p-2 border rounded" id="purchaseDate" required="" type="date"/>
<input class="w-full p-2 border rounded" id="price" placeholder="Price" required="" type="number"/>
<button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" type="submit">Submit</button>
</form>
</div>
<div class="max-w-3xl mx-auto mt-10">
<h2 class="text-xl font-semibold mb-4">üìã Ticket List</h2>
<div class="space-y-4" id="ticketList"></div>
</div>
</div>
<!-- Profile Content -->
<div class="content-section hidden" id="profileContent">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold text-gray-800">My Profile</h2>
</div>
<div class="bg-white shadow rounded-lg p-6">
<div class="flex flex-col md:flex-row md:items-center md:space-x-6 mb-6">
<div class="w-24 h-24 rounded-full bg-purple-100 flex items-center justify-center text-3xl font-bold text-purple-600 mb-4 md:mb-0" id="profileAvatar">
<!-- Initials will be inserted here -->
</div>
<div>
<h3 class="text-xl font-semibold text-gray-900 mb-1" id="profileDisplayName">John Doe</h3>
<p class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800" id="profileRoleBadge">Admin</p>
</div>
</div>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
<p class="text-gray-900" id="profileEmail">user@example.com</p>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Moderator Since</label>
<p class="text-gray-900" id="profileJoinDate">January 2023</p>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Last Login</label>
<p class="text-gray-900" id="profileLastLogin">Today at 10:30 AM</p>
</div>
<div class="pt-4 border-t border-gray-200">
<h4 class="font-medium text-gray-900 mb-3">Update Profile</h4>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
<input class="w-full border border-gray-300 rounded-md px-3 py-2" id="updateProfileName" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Departemen</label>

<select class="w-full border border-gray-300 rounded-md px-3 py-2" id="updateProfileRole" onchange="updateSubDivisions('updateProfileRole', 'updateProfileSubDivision')">
  <option value="">Pilih Departemen</option>
  <option value="Founder">Founder</option>
  <option value="Co-Founder">Co-Founder</option>
  <option value="Education">Education</option>
  <option value="Moderation">Moderation</option>
  <option value="Events">Events</option>
  <option value="Creative">Creative</option>
  <option value="Technology">Technology</option>
  <option value="Finance">Finance</option>
</select>

</div>
<div class="col-span-1 md:col-span-1"><label class="block text-sm font-medium text-gray-700 mb-1">Sub-Divisi</label>
<select class="w-full border border-gray-300 rounded-md px-3 py-2" id="updateProfileSubDivision" disabled>
  <option value="">Pilih Sub-Divisi</option>
  <option value="Koordinator Edukasi" data-role="Education">Koordinator Edukasi</option>
<option value="Mentor" data-role="Education">Mentor</option>
<option value="Pemateri" data-role="Education">Pemateri</option>
<option value="Notulen" data-role="Education">Notulen</option>
<option value="Head Moderator" data-role="Moderation">Head Moderator</option>
<option value="Moderator" data-role="Moderation">Moderator</option>
<option value="Helper" data-role="Moderation">Helper</option>
<option value="Support Staff" data-role="Moderation">Support Staff</option>
<option value="Event Coordinator" data-role="Events">Event Coordinator</option>
<option value="MC" data-role="Events">MC</option>
<option value="Host" data-role="Events">Host</option>
<option value="Giveaway Staff" data-role="Events">Giveaway Staff</option>
<option value="Content Lead" data-role="Creative">Content Lead</option>
<option value="Designer" data-role="Creative">Designer</option>
<option value="Editor" data-role="Creative">Editor</option>
<option value="Dokumentator" data-role="Creative">Dokumentator</option>
<option value="Social Media" data-role="Creative">Social Media</option>
<option value="Tech Lead" data-role="Technology">Tech Lead</option>
<option value="Bot Developer" data-role="Technology">Bot Developer</option>
<option value="Web Tools Support" data-role="Technology">Web Tools Support</option>
<option value="Database Admin" data-role="Technology">Database Admin</option>
<option value="Bendahara" data-role="Finance">Bendahara</option>
<option value="Pembukuan" data-role="Finance">Pembukuan</option>
<option value="Donasi" data-role="Finance">Donasi</option>
<option value="Anggaran" data-role="Finance">Anggaran</option>
<option value="Laporan Keuangan" data-role="Finance">Laporan Keuangan</option>

</select>
</div></div>
<div class="mt-3">
<label class="block text-sm font-medium text-gray-700 mb-1">Change Password</label>
<input class="w-full border border-gray-300 rounded-md px-3 py-2" id="updateProfilePassword" placeholder="Leave blank to keep current password" type="password"/>
</div>
<button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700" id="updateProfileBtn">
                                        Save Changes
                                    </button>
</div>
</div>
</div>
</div>
</div>
</div>
</main>
</div>
<!-- Add Event Modal -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="eventModal">
<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
<h2 class="text-xl font-bold text-blue-700 mb-4" id="eventModalTitle">Add New Event</h2>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Event Title</label>
<input class="w-full border border-gray-300 rounded-md px-3 py-2" id="eventTitle" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
<textarea class="w-full border border-gray-300 rounded-md px-3 py-2" id="eventDescription" rows="3"></textarea>
</div>
<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Budget (Rp)</label>
    <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="estimatedBudget" type="number" min="0"/>
</div>
<div>
    <label class="block text-sm font-medium text-gray-700 mb-1">Execution Date/Time</label>
    <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="executionDateTime" type="datetime-local"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Departments Involved</label>
<div class="space-y-2" id="eventDepartmentsList">
<!-- Department checkboxes will be loaded here -->
</div>
</div>
</div>
<div class="flex justify-end space-x-3 mt-6">
<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" id="cancelEventBtn">Cancel</button>
<button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="saveEventBtn">Save Event</button>
</div>
<input id="eventId" type="hidden"/>
</div>
</div>

<!-- Event Details Modal -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="eventDetailsModal">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-blue-700" id="detailEventTitle"></h2>
            <button class="text-gray-500 hover:text-gray-700" onclick="hideEventDetailsModal()">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <p class="text-gray-600 mb-4" id="detailEventDescription"></p>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <p class="text-sm font-medium text-gray-700">Budget:</p>
                <p class="text-gray-900" id="detailEstimatedBudget"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-700">Execution Date:</p>
                <p class="text-gray-900" id="detailExecutionDateTime"></p>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="font-medium text-gray-900 mb-2">Overall Progress: <span id="detailEventProgress">0%</span></h3>
            <div class="progress-bar">
                <div class="progress-fill bg-blue-500" id="detailEventProgressBar" style="width: 0%;"></div>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-3">Departments</h3>
        <div id="eventDetailsDepartmentsList" class="space-y-4">
            <!-- Departments, Subdivisions, and Tasks will be loaded here -->
        </div>
    </div>
</div>


<!-- Add Report Modal -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="reportModal">
<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
<h2 class="text-xl font-bold text-purple-700 mb-4">Report an Issue</h2>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Reported User</label>
<input class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportUser" placeholder="Username or ID" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
<select class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportCategory">
<option value="Behavior">Inappropriate Behavior</option>
<option value="Spam">Spam</option>
<option value="Harassment">Harassment</option>
<option value="Scam">Scam/Fraud</option>
<option value="Other">Other</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
<textarea class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportDescription" placeholder="Provide detailed information about the issue..." rows="4"></textarea>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
<select class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportStatus">
<option value="Pending">Pending</option>
<option value="Resolved">Resolved</option>
<option value="Ignored">Ignored</option>
</select>
</div>
</div>
<div class="flex justify-end space-x-3 mt-6">
<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" id="cancelReportBtn">Cancel</button>
<button class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700" id="saveReportBtn">Submit Report</button>
</div>
<input id="reportId" type="hidden"/>
</div>
</div>
<!-- Add Transaction Modal -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" id="transactionModal">
<div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
<h2 class="text-xl font-bold text-blue-700 mb-4">Add Transaction</h2>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
<div class="flex space-x-4">
<label class="inline-flex items-center">
<input checked="" class="h-4 w-4 text-blue-600" name="transactionType" type="radio" value="income"/>
<span class="ml-2">Income</span>
</label>
<label class="inline-flex items-center">
<input class="h-4 w-4 text-blue-600" name="transactionType" type="radio" value="expense"/>
<span class="ml-2">Expense</span>
</label>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
<div class="relative">
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<span class="text-gray-500">Rp</span>
</div>
<input class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md" id="transactionAmount" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
<input class="w-full border border-gray-300 rounded-md px-3 py-2" id="transactionDescription" type="text"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
<select class="w-full border border-gray-300 rounded-md px-3 py-2" id="transactionCategory">
<option value="Event">Event Support</option>
<option value="Tools">Tools &amp; Software</option>
<option value="Reward">Moderator Rewards</option>
<option value="Other">Other</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
<input class="w-full border border-gray-300 rounded-md px-3 py-2" id="transactionDate" type="date"/>
</div>
</div>
<div class="flex justify-end space-x-3 mt-6">
<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" id="cancelTransactionBtn">Cancel</button>
<button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" id="saveTransactionBtn">Save Transaction</button>
</div>
<input id="transactionId" type="hidden"/>
</div>
</div>
<script>
        // Firebase references
        const usersRef = db.ref('users');
        const moderatorsRef = db.ref('moderators');
        const eventsRef = db.ref('events');
        const reportsRef = db.ref('reports');
        const chatRef = db.ref('chat');
        const transactionsRef = db.ref('transactions');
        const onlineRef = db.ref('.info/connected');

        const roleColors = {
    "Founder": "red",
    "Co-Founder": "orange",
    "Education": "indigo",
    "Moderation": "blue",
    "Events": "green",
    "Creative": "purple",
    "Technology": "teal",
    "Finance": "yellow"
};

const subDivisionOptions = {
    "Education": ["Koordinator Edukasi", "Mentor", "Pemateri", "Notulen"],
    "Moderation": ["Head Moderator", "Moderator", "Helper", "Support Staff"],
    "Events": ["Event Coordinator", "MC", "Host", "Giveaway Staff"],
    "Creative": ["Content Lead", "Designer", "Editor", "Dokumentator", "Social Media"],
    "Technology": ["Tech Lead", "Bot Developer", "Web Tools Support", "Database Admin"],
    "Finance": ["Bendahara", "Pembukuan", "Donasi", "Anggaran", "Laporan Keuangan"]
};


// Global variables
        let currentUser = null;
        let currentSection = 'moderators';
        let currentUserData = null; // To store current user's role and subDivision

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Show auth modal at startup
            document.getElementById('authModal').classList.add('flex');
            document.getElementById('authModal').classList.remove('hidden');

            // Initialize UI events
            initAuthEvents();
            initTabEvents();
            initEventModalEvents();
            initReportModalEvents();
            initTransactionModalEvents();
            initProfileEvents();
            
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    // Fetch currentUserData immediately after login
                    usersRef.child(user.uid).once('value').then(snapshot => {
                        currentUserData = snapshot.val();
                        setupUserPresence();
                        checkProfileCompletion(user.uid);
                    }).catch(error => {
                        console.error("Error fetching current user data:", error);
                        // Proceed without currentUserData if fetch fails, but log the error
                        setupUserPresence();
                        checkProfileCompletion(user.uid);
                    });
                } else {
                    // No user is signed in
                    document.getElementById('authModal').classList.add('flex');
                    document.getElementById('authModal').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('profileForm').classList.add('hidden');
                }
            });
        });

        // Authentication functions
        function initAuthEvents() {
            // Login button
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            
            // Allow login on Enter key
            document.getElementById('loginPassword').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') loginUser();
            });

            // Save profile button
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logoutUser);
        }

        function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');

            if (!email || !password) {
                errorElement.textContent = 'Please enter both email and password';
                errorElement.classList.remove('hidden');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    errorElement.classList.add('hidden');
                })
                .catch((error) => {
                    errorElement.textContent = error.message;
                    errorElement.classList.remove('hidden');
                });
        }

        function checkProfileCompletion(uid) {
    		usersRef.child(uid).once('value').then(snapshot => {
        		const userData = snapshot.val();
        		console.log("üîç userData from DB:", userData);
                currentUserData = userData; // Store current user data globally

        	if (!userData || !userData.name || !userData.role) {
            		// Show profile form
            		document.getElementById('authModal').classList.add('flex');
            		document.getElementById('authModal').classList.remove('hidden');
            		document.getElementById('loginForm').classList.add('hidden');
            		document.getElementById('profileForm').classList.remove('hidden');

            // ‚úÖ Gunakan currentUser.email, bukan userData (yang bisa null)
            		document.getElementById('profileName').value = currentUser.email.split('@')[0];
        	} else {
            		document.getElementById('authModal').classList.remove('flex');
            		document.getElementById('authModal').classList.add('hidden');
            		document.getElementById('app').classList.remove('hidden');
            		loadAppData();
       			}
    		});
	}

        function saveProfile() {
            const name = document.getElementById('profileName').value;
            const role = document.getElementById('profileRole').value;
            const subDivision = document.getElementById('profileSubDivision')?.value || '';
            const password = document.getElementById('profilePassword').value;

            if (!name || !role) {
                alert('Please fill in all required fields');
                return;
            }

            const updates = {
                name: name,
                role: role,
                subDivision: subDivision, // ‚úÖ Pastikan ini ada
                profileComplete: true,
                joinedAt: new Date().toISOString() // Set joinedAt only on initial profile save
            };

            const userId = currentUser.uid;

            // Update user data
            usersRef.child(userId).update(updates).then(() => {
                // Update moderatorsRef name and role too
                moderatorsRef.child(userId).update({
                    name: name,
                    role: role,
                    subDivision: subDivision, // ‚úÖ Pastikan ini ada
                    joinedAt: updates.joinedAt, // Ensure joinedAt is consistent
                    lastSeen: new Date().toISOString()
                });
    
                // Update password if provided
                if (password) {
                    currentUser.updatePassword(password).catch(error => {
                        console.error('Error updating password:', error);
                    });
                }

                // Hide auth modal and show app
                document.getElementById('authModal').classList.remove('flex');
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadAppData();
            });
        }

	function setupUserPresence() {
	    const userId = currentUser.uid;
	    const userStatusRef = db.ref('status/' + userId);
	
	    // Listener untuk cek koneksi
	    const connectedRef = db.ref('.info/connected');
	    connectedRef.on('value', function(snapshot) {
	        if (snapshot.val() === true) {
	            userStatusRef.onDisconnect().set({
	                status: 'offline',
	                lastChanged: firebase.database.ServerValue.TIMESTAMP
	            }).then(() => {
	                // Set online ketika terkoneksi
	                userStatusRef.set({
	                    status: 'online',
	                    lastChanged: firebase.database.ServerValue.TIMESTAMP
	                });
	            });
	        }
	    });
	}
	
	function logoutUser() {
	    const userId = currentUser.uid;
	    const userStatusRef = db.ref('status/' + userId);
	
	    // üö® Paksa set offline saat logout
	    userStatusRef.set({
	        status: 'offline',
	        lastChanged: firebase.database.ServerValue.TIMESTAMP
	    }).then(() => {
	        // Hapus listener presence
	        db.ref('.info/connected').off();
	
	        // Sign out Firebase auth
	        auth.signOut().then(() => {
	            currentUser = null;
                currentUserData = null; // Clear user data on logout
	            document.getElementById('authModal').classList.add('flex');
	            document.getElementById('authModal').classList.remove('hidden');
	            document.getElementById('loginForm').classList.remove('hidden');
	            document.getElementById('profileForm').classList.add('hidden');
	            document.getElementById('app').classList.add('hidden');
	        });
	    });
	}
	

        // Tab navigation functions
        function initTabEvents() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.id.replace('Tab', '');
                    switchSection(tabId);
                });
            });
        }

        function switchSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.classList.remove('bg-blue-100', 'text-blue-800');
                button.classList.add('text-gray-600', 'hover:bg-gray-100');
            });

            // Show selected section
            document.getElementById(sectionId + 'Content').classList.remove('hidden');

            // Activate selected tab button
            document.getElementById(sectionId + 'Tab').classList.remove('text-gray-600', 'hover:bg-gray-100');
            document.getElementById(sectionId + 'Tab').classList.add('bg-blue-100', 'text-blue-800');

            currentSection = sectionId;

            // Load specific section data
            switch(sectionId) {
                case 'moderators':
                    loadModerators();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'chat':
                    loadChat();
                    break;
                case 'finance':
                    loadFinance();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'ticketing':
                    // Ticketing logic is handled by DOMContentLoaded listener
                    break;
            }
        }

        // Load all initial app data
        function loadAppData() {
            loadModerators();
            loadEvents();
            loadReports();
            loadChat();
            loadFinance();
            loadProfile();
            updateQuickStats();
        }

        // Moderators functions
        function loadModerators() {
            const moderatorsList = document.getElementById('moderatorsList');
            moderatorsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

            moderatorsRef.orderByChild('role').off(); 
            moderatorsRef.orderByChild('role').on('value', snapshot => {
                const moderators = snapshot.val();
                if (!moderators) {
                    moderatorsList.innerHTML = '<p class="text-center py-8 text-gray-500">No moderators found</p>';
                    document.getElementById('moderatorCount').textContent = '0';
                    return;
                }

                const moderatorArray = Object.entries(moderators);

                // Sort by role hierarchy: Admin > Staff > Helper
                // Assuming roles are defined in roleColors and ordered implicitly or explicitly
                const roleOrder = Object.keys(roleColors); // Use the order of keys in roleColors
                moderatorArray.sort((a, b) => {
                    const roleA = a[1].role || 'Member';
                    const roleB = b[1].role || 'Member';
                    return roleOrder.indexOf(roleA) - roleOrder.indexOf(roleB);
                });

                // ‚úÖ Menggunakan Promise.all untuk menunggu semua status dimuat sebelum merender
                const moderatorCardsPromises = moderatorArray.map(([id, mod]) => {
                    return new Promise(resolve => {
                        db.ref('status/' + id).on('value', statusSnap => {
                            const status = statusSnap.val();
                            const isOnline = status && status.status === 'online';
                            resolve(createModeratorCard(id, mod, isOnline));
                        });
                    });
                });

                Promise.all(moderatorCardsPromises).then(cardsHtml => {
                    moderatorsList.innerHTML = cardsHtml.join('');
                    document.getElementById('moderatorCount').textContent = moderatorArray.length;
                });
            });

            // Update online count based on status changes
            db.ref('status').on('value', snapshot => {
                let onlineCount = 0;
                snapshot.forEach(childSnap => {
                    if (childSnap.val().status === 'online') {
                        onlineCount++;
                    }
                });
                document.getElementById('onlineCount').textContent = onlineCount;
            });
        }

        function createModeratorCard(id, mod, isOnline) {
            return `
                <div class="bg-white p-4 rounded-lg shadow flex items-start space-x-4" id="mod-card-${id}">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full bg-${isOnline ? 'green' : 'gray'}-100 flex items-center justify-center font-bold text-${isOnline ? 'green' : 'gray'}-600">
                            ${mod.name ? mod.name.substring(0, 1).toUpperCase() : '?'}
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white bg-${isOnline ? 'green' : 'gray'}-500"></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-medium text-gray-900">${mod.name || 'Unknown'}</h3>
                        <div class="flex items-center space-x-2 mt-1">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${`bg-${roleColors[mod.role] || "gray"}-100 text-${roleColors[mod.role] || "gray"}-800`}">
                                ${mod.role || 'Member'}${mod.subDivision ? ' - ' + mod.subDivision : ''}
                            </span>
                            <span class="text-xs text-gray-500">Since ${mod.joinedAt ? new Date(mod.joinedAt).toLocaleDateString() : 'unknown'}</span>
                        </div>
                        <div class="text-sm text-indigo-600 mt-1">${mod.subDivision || "No Sub-Divisi"}</div>
                        <div class="mt-2 text-sm text-gray-500">
                            ${isOnline ? 'Online now' : `Last seen ${mod.lastSeen ? formatLastSeen(mod.lastSeen) : 'unknown'}`}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatLastSeen(timestamp) {
            const now = new Date();
            const lastSeen = new Date(timestamp);
            const diffInMinutes = Math.floor((now - lastSeen) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'just now';
            if (diffInMinutes < 60) return `${diffInMinutes} minute${diffInMinutes === 1 ? '' : 's'} ago`;
            if (diffInMinutes < 24 * 60) return `${Math.floor(diffInMinutes / 60)} hour${Math.floor(diffInMinutes / 60) === 1 ? '' : 's'} ago`;
            return `${Math.floor(diffInMinutes / (60 * 24))} day${Math.floor(diffInMinutes / (60 * 24)) === 1 ? '' : 's'} ago`;
        }

        // Events functions
        function initEventModalEvents() {
            // Event modal buttons (Add/Edit Event)
            document.getElementById('addEventBtn').addEventListener('click', function() {
                showEventModal();
            });

            document.getElementById('cancelEventBtn').addEventListener('click', function() {
                hideEventModal();
            });

            document.getElementById('saveEventBtn').addEventListener('click', function() {
                saveEvent();
            });
        }

        function showEventModal(eventId = null) {
            document.getElementById('eventModal').classList.add('active');
            document.getElementById('eventModal').classList.remove('hidden');
            document.getElementById('eventId').value = eventId || '';
            document.getElementById('eventModalTitle').textContent = eventId ? 'Edit Event' : 'Add New Event';

            const eventDepartmentsList = document.getElementById('eventDepartmentsList');
            eventDepartmentsList.innerHTML = '';
            const allDepartments = Object.keys(roleColors).filter(role => role !== 'Founder' && role !== 'Co-Founder');

            // Clear previous department/subdivision selections
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('estimatedBudget').value = '';
            document.getElementById('executionDateTime').value = '';
            eventDepartmentsList.innerHTML = ''; // Clear previous checkboxes

            if (eventId) {
                eventsRef.child(eventId).once('value').then(snapshot => {
                    const event = snapshot.val();
                    if (event) {
                        document.getElementById('eventTitle').value = event.title || '';
                        document.getElementById('eventDescription').value = event.description || '';
                        document.getElementById('estimatedBudget').value = event.estimatedBudget || '';
                        document.getElementById('executionDateTime').value = event.executionDateTime || '';
                        
                        allDepartments.forEach(dept => {
                            const isDeptChecked = event.departments && event.departments[dept];
                            let deptHtml = `
                                <div class="flex flex-col mb-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="dept_${dept}" value="${dept}" ${isDeptChecked ? 'checked' : ''} class="h-4 w-4 text-blue-600 rounded" onchange="toggleSubdivisions('${dept}', this.checked, '${eventId}')">
                                        <span class="ml-2 text-sm font-medium text-gray-700">${dept}</span>
                                    </label>
                                    <div id="subdivisions_for_${dept}" class="ml-6 mt-1 space-y-1 ${isDeptChecked ? '' : 'hidden'}">
                                        <!-- Subdivisions will be loaded here dynamically -->
                                    </div>
                                </div>
                            `;
                            eventDepartmentsList.innerHTML += deptHtml;
                            if (isDeptChecked) {
                                loadSubdivisionCheckboxes(dept, event.departments[dept]?.subdivisions || {}, eventId);
                            }
                        });
                    }
                });
            } else {
                allDepartments.forEach(dept => {
                    eventDepartmentsList.innerHTML += `
                        <div class="flex flex-col mb-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="dept_${dept}" value="${dept}" class="h-4 w-4 text-blue-600 rounded" onchange="toggleSubdivisions('${dept}', this.checked)">
                                <span class="ml-2 text-sm font-medium text-gray-700">${dept}</span>
                            </label>
                            <div id="subdivisions_for_${dept}" class="ml-6 mt-1 space-y-1 hidden">
                                <!-- Subdivisions will be loaded here dynamically -->
                            </div>
                        </div>
                    `;
                });
            }
        }

        function hideEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            document.getElementById('eventModal').classList.add('hidden');
        }

        function loadEvents() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

            eventsRef.orderByChild('executionDateTime').off(); 
            eventsRef.orderByChild('executionDateTime').on('value', snapshot => {
                const events = snapshot.val();
                if (!events) {
                    eventsList.innerHTML = '<p class="text-center py-8 text-gray-500">No events scheduled yet</p>';
                    document.getElementById('activeEventCount').textContent = '0';
                    return;
                }

                let html = '';
                let activeCount = 0;
                const eventArray = Object.entries(events);

                eventArray.forEach(([id, event]) => {
                    const eventDate = new Date(event.executionDateTime);
                    const now = new Date();
                    // Consider event active if its execution date is in the future or today
                    const isActive = eventDate >= now; 
                    if (isActive) activeCount++;

                    const progress = event.progress ? (event.progress * 100).toFixed(0) : 0;
                    const progressColor = progress == 100 ? 'green' : 'blue';

                    html += `
                        <div class="bg-white p-4 rounded-lg shadow" data-event-id="${id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium text-lg text-gray-900">${event.title}</h3>
                                    <p class="text-sm text-gray-500">${event.description}</p>
                                    <p class="text-sm text-gray-500">Budget: Rp ${event.estimatedBudget ? event.estimatedBudget.toLocaleString() : '0'}</p>
                                    <p class="text-sm text-gray-500">Date: ${new Date(event.executionDateTime).toLocaleString()}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="showEventModal('${id}')" class="p-1 text-blue-600 hover:text-blue-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteEvent('${id}')" class="p-1 text-red-600 hover:text-red-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                    <button onclick="showEventDetailsModal('${id}')" class="p-1 text-purple-600 hover:text-purple-800">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-${progressColor}-800">Progress: ${progress}%</span>
                                    <span class="text-sm text-gray-500">${formatDateDistance(event.executionDateTime)}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-${progressColor}-500" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                eventsList.innerHTML = html;
                document.getElementById('activeEventCount').textContent = activeCount;
            });
        }

        async function saveEvent() {
            const eventId = document.getElementById('eventId').value;
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const estimatedBudget = parseFloat(document.getElementById('estimatedBudget').value) || 0;
            const executionDateTime = document.getElementById('executionDateTime').value;
            
            const selectedDepartments = {};
            document.querySelectorAll('#eventDepartmentsList input[type="checkbox"][id^="dept_"]:checked').forEach(deptCheckbox => {
                const deptName = deptCheckbox.value;
                selectedDepartments[deptName] = { progress: 0, subdivisions: {} }; // Initialize department with 0 progress and empty subdivisions

                // Collect selected subdivisions for this department
                document.querySelectorAll(`#subdivisions_for_${deptName} input[type="checkbox"]:checked`).forEach(subDivCheckbox => {
                    const subDivName = subDivCheckbox.value;
                    selectedDepartments[deptName].subdivisions[subDivName] = { progress: 0 }; // Initialize subdivision with 0 progress
                });
            });

            if (!title || !executionDateTime || Object.keys(selectedDepartments).length === 0) {
                alert('Please fill in title, execution date/time, and select at least one department.');
                return;
            }

            const eventData = {
                title,
                description,
                estimatedBudget,
                executionDateTime,
                departments: selectedDepartments,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            if (eventId) {
                // Update existing event
                const existingEvent = (await eventsRef.child(eventId).once('value')).val();
                if (existingEvent && existingEvent.departments) {
                    // Preserve existing department and subdivision structure if re-selected
                    Object.keys(selectedDepartments).forEach(deptName => {
                        if (existingEvent.departments[deptName]) {
                            selectedDepartments[deptName].progress = existingEvent.departments[deptName].progress || 0;
                            if (existingEvent.departments[deptName].subdivisions) {
                                Object.keys(selectedDepartments[deptName].subdivisions).forEach(subDivName => {
                                    if (existingEvent.departments[deptName].subdivisions[subDivName]) {
                                        selectedDepartments[deptName].subdivisions[subDivName] = existingEvent.departments[deptName].subdivisions[subDivName];
                                    }
                                });
                            }
                        }
                    });
                }
                eventData.departments = selectedDepartments;
                await eventsRef.child(eventId).update(eventData);
            } else {
                // Create new event
                eventData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                eventData.createdBy = currentUser.uid;
                const newEventRef = eventsRef.push();
                await newEventRef.set(eventData);
            }

            hideEventModal();
            loadEvents(); // Reload events to show updates
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                eventsRef.child(eventId).remove().then(() => {
                    alert('Event deleted successfully.');
                    loadEvents(); // Reload events after deletion
                }).catch(error => {
                    alert('Error deleting event: ' + error.message);
                });
            }
        }

        function formatDateDistance(dateTimeString) {
            const now = new Date();
            const eventDate = new Date(dateTimeString);
            const diffInMs = eventDate - now;
            const diffInDays = Math.floor((now - lastSeen) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'just now';
            if (diffInMinutes < 60) return `${diffInMinutes} minute${diffInMinutes === 1 ? '' : 's'} ago`;
            if (diffInMinutes < 24 * 60) return `${Math.floor(diffInMinutes / 60)} hour${Math.floor(diffInMinutes / 60) === 1 ? '' : 's'} ago`;
            return `${Math.floor(diffInMinutes / (60 * 24))} day${Math.floor(diffInMinutes / (60 * 24)) === 1 ? '' : 's'} ago`;
        }

        // Events functions
        function initEventModalEvents() {
            // Event modal buttons (Add/Edit Event)
            document.getElementById('addEventBtn').addEventListener('click', function() {
                showEventModal();
            });

            document.getElementById('cancelEventBtn').addEventListener('click', function() {
                hideEventModal();
            });

            document.getElementById('saveEventBtn').addEventListener('click', function() {
                saveEvent();
            });
        }

        function showEventModal(eventId = null) {
            document.getElementById('eventModal').classList.add('active');
            document.getElementById('eventModal').classList.remove('hidden');
            document.getElementById('eventId').value = eventId || '';
            document.getElementById('eventModalTitle').textContent = eventId ? 'Edit Event' : 'Add New Event';

            const eventDepartmentsList = document.getElementById('eventDepartmentsList');
            eventDepartmentsList.innerHTML = '';
            const allDepartments = Object.keys(roleColors).filter(role => role !== 'Founder' && role !== 'Co-Founder');

            // Clear previous department/subdivision selections
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('estimatedBudget').value = '';
            document.getElementById('executionDateTime').value = '';
            eventDepartmentsList.innerHTML = ''; // Clear previous checkboxes

            if (eventId) {
                eventsRef.child(eventId).once('value').then(snapshot => {
                    const event = snapshot.val();
                    if (event) {
                        document.getElementById('eventTitle').value = event.title || '';
                        document.getElementById('eventDescription').value = event.description || '';
                        document.getElementById('estimatedBudget').value = event.estimatedBudget || '';
                        document.getElementById('executionDateTime').value = event.executionDateTime || '';
                        
                        allDepartments.forEach(dept => {
                            const isDeptChecked = event.departments && event.departments[dept];
                            let deptHtml = `
                                <div class="flex flex-col mb-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="dept_${dept}" value="${dept}" ${isDeptChecked ? 'checked' : ''} class="h-4 w-4 text-blue-600 rounded" onchange="toggleSubdivisions('${dept}', this.checked, '${eventId}')">
                                        <span class="ml-2 text-sm font-medium text-gray-700">${dept}</span>
                                    </label>
                                    <div id="subdivisions_for_${dept}" class="ml-6 mt-1 space-y-1 ${isDeptChecked ? '' : 'hidden'}">
                                        <!-- Subdivisions will be loaded here dynamically -->
                                    </div>
                                </div>
                            `;
                            eventDepartmentsList.innerHTML += deptHtml;
                            if (isDeptChecked) {
                                loadSubdivisionCheckboxes(dept, event.departments[dept]?.subdivisions || {}, eventId);
                            }
                        });
                    }
                });
            } else {
                allDepartments.forEach(dept => {
                    eventDepartmentsList.innerHTML += `
                        <div class="flex flex-col mb-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="dept_${dept}" value="${dept}" class="h-4 w-4 text-blue-600 rounded" onchange="toggleSubdivisions('${dept}', this.checked)">
                                <span class="ml-2 text-sm font-medium text-gray-700">${dept}</span>
                            </label>
                            <div id="subdivisions_for_${dept}" class="ml-6 mt-1 space-y-1 hidden">
                                <!-- Subdivisions will be loaded here dynamically -->
                            </div>
                        </div>
                    `;
                });
            }
        }

        function hideEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            document.getElementById('eventModal').classList.add('hidden');
        }

        function loadEvents() {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

            eventsRef.orderByChild('executionDateTime').off(); 
            eventsRef.orderByChild('executionDateTime').on('value', snapshot => {
                const events = snapshot.val();
                if (!events) {
                    eventsList.innerHTML = '<p class="text-center py-8 text-gray-500">No events scheduled yet</p>';
                    document.getElementById('activeEventCount').textContent = '0';
                    return;
                }

                let html = '';
                let activeCount = 0;
                const eventArray = Object.entries(events);

                eventArray.forEach(([id, event]) => {
                    const eventDate = new Date(event.executionDateTime);
                    const now = new Date();
                    // Consider event active if its execution date is in the future or today
                    const isActive = eventDate >= now; 
                    if (isActive) activeCount++;

                    const progress = event.progress ? (event.progress * 100).toFixed(0) : 0;
                    const progressColor = progress == 100 ? 'green' : 'blue';

                    html += `
                        <div class="bg-white p-4 rounded-lg shadow" data-event-id="${id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium text-lg text-gray-900">${event.title}</h3>
                                    <p class="text-sm text-gray-500">${event.description}</p>
                                    <p class="text-sm text-gray-500">Budget: Rp ${event.estimatedBudget ? event.estimatedBudget.toLocaleString() : '0'}</p>
                                    <p class="text-sm text-gray-500">Date: ${new Date(event.executionDateTime).toLocaleString()}</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="showEventModal('${id}')" class="p-1 text-blue-600 hover:text-blue-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteEvent('${id}')" class="p-1 text-red-600 hover:text-red-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                    <button onclick="showEventDetailsModal('${id}')" class="p-1 text-purple-600 hover:text-purple-800">
                                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-${progressColor}-800">Progress: ${progress}%</span>
                                    <span class="text-sm text-gray-500">${formatDateDistance(event.executionDateTime)}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill bg-${progressColor}-500" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                eventsList.innerHTML = html;
                document.getElementById('activeEventCount').textContent = activeCount;
            });
        }

        async function saveEvent() {
            const eventId = document.getElementById('eventId').value;
            const title = document.getElementById('eventTitle').value;
            const description = document.getElementById('eventDescription').value;
            const estimatedBudget = parseFloat(document.getElementById('estimatedBudget').value) || 0;
            const executionDateTime = document.getElementById('executionDateTime').value;
            
            const selectedDepartments = {};
            document.querySelectorAll('#eventDepartmentsList input[type="checkbox"][id^="dept_"]:checked').forEach(deptCheckbox => {
                const deptName = deptCheckbox.value;
                selectedDepartments[deptName] = { progress: 0, subdivisions: {} }; // Initialize department with 0 progress and empty subdivisions

                // Collect selected subdivisions for this department
                document.querySelectorAll(`#subdivisions_for_${deptName} input[type="checkbox"]:checked`).forEach(subDivCheckbox => {
                    const subDivName = subDivCheckbox.value;
                    selectedDepartments[deptName].subdivisions[subDivName] = { progress: 0 }; // Initialize subdivision with 0 progress
                });
            });

            if (!title || !executionDateTime || Object.keys(selectedDepartments).length === 0) {
                alert('Please fill in title, execution date/time, and select at least one department.');
                return;
            }

            const eventData = {
                title,
                description,
                estimatedBudget,
                executionDateTime,
                departments: selectedDepartments,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            if (eventId) {
                // Update existing event
                const existingEvent = (await eventsRef.child(eventId).once('value')).val();
                if (existingEvent && existingEvent.departments) {
                    // Preserve existing department and subdivision structure if re-selected
                    Object.keys(selectedDepartments).forEach(deptName => {
                        if (existingEvent.departments[deptName]) {
                            selectedDepartments[deptName].progress = existingEvent.departments[deptName].progress || 0;
                            if (existingEvent.departments[deptName].subdivisions) {
                                Object.keys(selectedDepartments[deptName].subdivisions).forEach(subDivName => {
                                    if (existingEvent.departments[deptName].subdivisions[subDivName]) {
                                        selectedDepartments[deptName].subdivisions[subDivName] = existingEvent.departments[deptName].subdivisions[subDivName];
                                    }
                                });
                            }
                        }
                    });
                }
                eventData.departments = selectedDepartments;
                await eventsRef.child(eventId).update(eventData);
            } else {
                // Create new event
                eventData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                eventData.createdBy = currentUser.uid;
                const newEventRef = eventsRef.push();
                await newEventRef.set(eventData);
            }

            hideEventModal();
            loadEvents(); // Reload events to show updates
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                eventsRef.child(eventId).remove().then(() => {
                    alert('Event deleted successfully.');
                    loadEvents(); // Reload events after deletion
                }).catch(error => {
                    alert('Error deleting event: ' + error.message);
                });
            }
        }

        function formatDateDistance(dateTimeString) {
            const now = new Date();
            const eventDate = new Date(dateTimeString);
            const diffInMs = eventDate - now;
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInDays < 0) return 'Event passed';
            if (diffInDays === 0) {
                const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
                if (diffInHours === 0) return 'Happening soon';
                return `Today, in ${diffInHours} hour${diffInHours === 1 ? '' : 's'}`;
            }
            if (diffInDays === 1) return 'Tomorrow';
            if (diffInDays < 7) return `In ${diffInDays} days`;
            if (diffInDays < 30) return `In ${Math.floor(diffInDays / 7)} week${Math.floor(diffInDays / 7) > 1 ? 's' : ''}`;
            return `On ${eventDate.toLocaleDateString()}`;
        }

        // Event Details Modal Functions
        async function showEventDetailsModal(eventId) {
            document.getElementById('eventDetailsModal').classList.add('active');
            document.getElementById('eventDetailsModal').classList.remove('hidden');

            const eventSnapshot = await eventsRef.child(eventId).once('value');
            const event = eventSnapshot.val();

            if (!event) {
                alert('Event not found.');
                hideEventDetailsModal();
                return;
            }

            document.getElementById('detailEventTitle').textContent = event.title;
            document.getElementById('detailEventDescription').textContent = event.description;
            document.getElementById('detailEstimatedBudget').textContent = `Rp ${event.estimatedBudget ? event.estimatedBudget.toLocaleString() : '0'}`;
            document.getElementById('detailExecutionDateTime').textContent = new Date(event.executionDateTime).toLocaleString();

            const departmentsListEl = document.getElementById('eventDetailsDepartmentsList');
            departmentsListEl.innerHTML = '';

            // Listen for real-time updates on this specific event
            eventsRef.child(eventId).on('value', async (updatedEventSnapshot) => {
                const updatedEvent = updatedEventSnapshot.val();
                if (!updatedEvent) {
                    hideEventDetailsModal(); // Event might have been deleted
                    return;
                }

                // Update overall event progress
                const overallProgress = updatedEvent.progress ? (updatedEvent.progress * 100).toFixed(0) : 0;
                document.getElementById('detailEventProgress').textContent = `${overallProgress}%`;
                document.getElementById('detailEventProgressBar').style.width = `${overallProgress}%`;
                document.getElementById('detailEventProgressBar').className = `progress-fill bg-${overallProgress == 100 ? 'green' : 'blue'}-500`;

                departmentsListEl.innerHTML = ''; // Clear before re-rendering

                const departments = updatedEvent.departments || {};
                for (const deptName of Object.keys(departments)) {
                    const department = departments[deptName];
                    const deptProgress = department.progress ? (department.progress * 100).toFixed(0) : 0;
                    const deptProgressColor = deptProgress == 100 ? 'green' : 'blue';

                    // Check if current user belongs to this department
                    const canAddSubdivision = currentUserData && currentUserData.role === deptName;

                    let departmentHtml = `
                        <div class="department-item p-3 border rounded-md shadow-sm mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-lg text-gray-800">${deptName}</h4>
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm font-medium text-${deptProgressColor}-800">${deptProgress}%</span>
                                    ${canAddSubdivision ? `
                                    <button onclick="promptAddSubdivision('${eventId}', '${deptName}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Add Sub-Divisi</button>
                                    ` : ''}
                                    <button onclick="deleteDepartment('${eventId}', '${deptName}')" class="text-red-500 hover:text-red-700 text-sm">Delete Dept</button>
                                </div>
                            </div>
                            <div class="progress-bar mb-3">
                                <div class="progress-fill bg-${deptProgressColor}-500" style="width: ${deptProgress}%"></div>
                            </div>
                            <div class="nested-progress-container space-y-3" id="subdivisions-list-${deptName}">
                                <!-- Subdivisions will be loaded here -->
                            </div>
                        </div>
                    `;
                    departmentsListEl.innerHTML += departmentHtml;

                    const subdivisionsListEl = document.getElementById(`subdivisions-list-${deptName}`);
                    const subdivisions = department.subdivisions || {};

                    for (const subDivName of Object.keys(subdivisions)) {
                        const subdivision = subdivisions[subDivName];
                        const subDivProgress = subdivision.progress ? (subdivision.progress * 100).toFixed(0) : 0;
                        const subDivProgressColor = subDivProgress == 100 ? 'green' : 'blue';

                        // Check if current user belongs to this subdivision
                        const canAddTasks = currentUserData && currentUserData.role === deptName && currentUserData.subDivision === subDivName;
                        // Bug Fix: Allow PIC to edit their own tasks
                        const canEditAnyTaskInSubdivision = currentUserData && currentUserData.role === deptName && currentUserData.subDivision === subDivName;


                        let subdivisionHtml = `
                            <div class="subdivision-item p-3 border rounded-md shadow-sm mb-2">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="font-medium text-md text-gray-700">${subDivName}</h5>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-medium text-${subDivProgressColor}-800">${subDivProgress}%</span>
                                        ${canAddTasks ? `
                                        <button onclick="promptAddTask('${eventId}', '${deptName}', '${subDivName}')" class="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600">Add Task</button>
                                        ` : ''}
                                        <button onclick="deleteSubdivision('${eventId}', '${deptName}', '${subDivName}')" class="text-red-500 hover:text-red-700 text-sm">Delete Sub-Divisi</button>
                                    </div>
                                </div>
                                <div class="progress-bar mb-3">
                                    <div class="progress-fill bg-${subDivProgressColor}-500" style="width: ${subDivProgress}%"></div>
                                </div>
                                <div class="nested-progress-container space-y-2" id="tasks-list-${deptName}-${subDivName}">
                                    <!-- Tasks will be loaded here -->
                                </div>
                            </div>
                        `;
                        subdivisionsListEl.innerHTML += subdivisionHtml;

                        const tasksListEl = document.getElementById(`tasks-list-${deptName}-${subDivName}`);
                        const tasks = subdivision.tasks || {};

                        for (const taskId of Object.keys(tasks)) {
                            const task = tasks[taskId];
                            const taskStatusColor = task.status === 'complete' ? 'green' : 'orange';
                            // Bug Fix: Allow PIC to edit their own tasks
                            const isPIC = currentUserData && currentUserData.uid === task.PIC;
                            const canEditTask = isPIC || canEditAnyTaskInSubdivision; // PIC or anyone in the subdivision can edit

                            tasksListEl.innerHTML += `
                                <div class="task-item p-2 border rounded-md flex justify-between items-center">
                                    <div>
                                        <p class="font-normal text-gray-800">${task.title}</p>
                                        <p class="text-xs text-gray-500">PIC: ${task.PICName || 'Unknown'} | Status: <span class="font-medium text-${taskStatusColor}-600">${task.status}</span></p>
                                    </div>
                                    <div class="flex space-x-2">
                                        ${canEditTask ? `
                                        <select onchange="updateTaskStatus('${eventId}', '${deptName}', '${subDivName}', '${taskId}', this.value)" class="border rounded-md text-sm px-2 py-1">
                                            <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="in process" ${task.status === 'in process' ? 'selected' : ''}>In Process</option>
                                            <option value="complete" ${task.status === 'complete' ? 'selected' : ''}>Complete</option>
                                            <option value="incomplete" ${task.status === 'incomplete' ? 'selected' : ''}>Incomplete</option>
                                        </select>
                                        <button onclick="deleteTask('${eventId}', '${deptName}', '${subDivName}', '${taskId}')" class="text-red-500 hover:text-red-700 text-sm">Delete</button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            });
        }

        function hideEventDetailsModal() {
            document.getElementById('eventDetailsModal').classList.remove('active');
            document.getElementById('eventDetailsModal').classList.add('hidden');
            // Detach listener when modal is closed to prevent memory leaks
            // const currentEventId = document.getElementById('detailEventTitle').textContent; // A bit hacky, but works if title is unique
            eventsRef.off('value'); // Detach all listeners for eventsRef
            loadEvents(); // Reload main events list to ensure consistency
        }

        // CRUD for Departments, Subdivisions, Tasks
        async function promptAddSubdivision(eventId, departmentName) {
            if (!currentUserData || currentUserData.role !== departmentName) {
                alert('You do not have permission to add subdivisions to this department.');
                return;
            }

            const availableSubdivisions = subDivisionOptions[departmentName] || [];
            if (availableSubdivisions.length === 0) {
                alert(`No predefined subdivisions for ${departmentName}.`);
                return;
            }

            // The prompt above doesn't render HTML, so we'll use a custom modal or a simpler prompt
            const selectedSubdivision = prompt(`Enter the name of the Sub-Divisi for ${departmentName} (e.g., ${availableSubdivisions.join(', ')}):`);

            if (selectedSubdivision) {
                if (!availableSubdivisions.includes(selectedSubdivision)) {
                    alert(`"${selectedSubdivision}" is not a valid sub-division for ${departmentName}. Please choose from: ${availableSubdivisions.join(', ')}`);
                    return;
                }
                await addOrUpdateSubdivision(eventId, departmentName, selectedSubdivision);
            }
        }

        async function addOrUpdateSubdivision(eventId, departmentName, subdivisionName) {
            const subDivRef = eventsRef.child(eventId).child('departments').child(departmentName).child('subdivisions').child(subdivisionName);
            await subDivRef.update({ progress: 0 }); // Initialize progress
            await calculateProgress(eventId); // Recalculate progress for event
        }

        async function promptAddTask(eventId, departmentName, subdivisionName) {
            if (!currentUserData || currentUserData.role !== departmentName || currentUserData.subDivision !== subdivisionName) {
                alert('You do not have permission to add tasks to this subdivision.');
                return;
            }

            const taskTitle = prompt('Enter the new task title:');
            if (taskTitle) {
                const taskId = db.ref().push().key; // Generate unique ID for task
                const taskData = {
                    title: taskTitle,
                    status: 'pending',
                    PIC: currentUser.uid,
                    PICName: currentUserData.name || currentUser.email.split('@')[0]
                };
                await addOrUpdateTask(eventId, departmentName, subdivisionName, taskId, taskData);
            }
        }

        async function addOrUpdateTask(eventId, departmentName, subdivisionName, taskId, taskData) {
            const taskRef = eventsRef.child(eventId).child('departments').child(departmentName).child('subdivisions').child(subdivisionName).child('tasks').child(taskId);
            await taskRef.set(taskData);
            await calculateProgress(eventId); // Recalculate progress for event
        }

        async function updateTaskStatus(eventId, departmentName, subdivisionName, taskId, newStatus) {
            const taskRef = eventsRef.child(eventId).child('departments').child(departmentName).child('subdivisions').child(subdivisionName).child('tasks').child(taskId);
            await taskRef.update({ status: newStatus });
            await calculateProgress(eventId); // Recalculate progress for event
        }

        async function deleteTask(eventId, departmentName, subdivisionName, taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            const taskRef = eventsRef.child(eventId).child('departments').child(departmentName).child('subdivisions').child(subdivisionName).child('tasks').child(taskId);
            await taskRef.remove();
            await calculateProgress(eventId); // Recalculate progress for event
        }

        async function deleteSubdivision(eventId, departmentName, subdivisionName) {
            if (!confirm('Are you sure you want to delete this subdivision and all its tasks?')) return;
            const subDivRef = eventsRef.child(eventId).child('departments').child(departmentName).child('subdivisions').child(subdivisionName);
            await subDivRef.remove();
            await calculateProgress(eventId); // Recalculate progress for event
        }

        async function deleteDepartment(eventId, departmentName) {
            if (!confirm('Are you sure you want to delete this department from the event and all its subdivisions/tasks?')) return;
            const deptRef = eventsRef.child(eventId).child('departments').child(departmentName);
            await deptRef.remove();
            await calculateProgress(eventId); // Recalculate progress for event
        }

        // Progress Calculation Logic
        async function calculateProgress(eventId) {
            const eventRef = eventsRef.child(eventId);
            const eventSnapshot = await eventRef.once('value');
            const eventData = eventSnapshot.val();

            if (!eventData || !eventData.departments) {
                await eventRef.update({ progress: 0 });
                return;
            }

            let totalDeptProgress = 0;
            let deptCount = 0;

            for (const deptName in eventData.departments) {
                const department = eventData.departments[deptName];
                let totalSubDivProgress = 0;
                let subDivCount = 0;

                if (department.subdivisions) {
                    for (const subDivName in department.subdivisions) {
                        const subdivision = department.subdivisions[subDivName];
                        let completedTasks = 0;
                        let totalTasks = 0;

                        if (subdivision.tasks) {
                            for (const taskId in subdivision.tasks) {
                                totalTasks++;
                                if (subdivision.tasks[taskId].status === 'complete') {
                                    completedTasks++;
                                }
                            }
                        }
                        const subDivProgress = totalTasks > 0 ? completedTasks / totalTasks : 0;
                        totalSubDivProgress += subDivProgress;
                        subDivCount++;

                        // Update subdivision progress in Firebase
                        await eventRef.child('departments').child(deptName).child('subdivisions').child(subDivName).update({ progress: subDivProgress });
                    }
                }
                const deptProgress = subDivCount > 0 ? totalSubDivProgress / subDivCount : 0;
                totalDeptProgress += deptProgress;
                deptCount++;

                // Update department progress in Firebase
                await eventRef.child('departments').child(deptName).update({ progress: deptProgress });
            }

            const overallEventProgress = deptCount > 0 ? totalDeptProgress / deptCount : 0;
            // Update overall event progress in Firebase
            await eventRef.update({ progress: overallEventProgress });
        }


        // Reports functions
        function initReportModalEvents() {
            document.getElementById('addReportBtn').addEventListener('click', function() {
                showReportModal();
            });

            document.getElementById('cancelReportBtn').addEventListener('click', function() {
                hideReportModal();
            });

            document.getElementById('saveReportBtn').addEventListener('click', function() {
                saveReport();
            });

            document.getElementById('reportFilter').addEventListener('change', function() {
                loadReports();
            });
        }

        function showReportModal(reportId = null) {
            document.getElementById('reportModal').classList.add('active');
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportId').value = reportId || '';

            if (reportId) {
                // Load existing report data
                reportsRef.child(reportId).once('value').then(snapshot => {
                    const report = snapshot.val();
                    if (report) {
                        document.getElementById('reportUser').value = report.reportedUser || '';
                        document.getElementById('reportCategory').value = report.category || 'Behavior';
                        document.getElementById('reportDescription').value = report.description || '';
                        document.getElementById('reportStatus').value = report.status || 'Pending';
                    }
                });
            } else {
                // Clear form for new report
                document.getElementById('reportUser').value = '';
                document.getElementById('reportCategory').value = 'Behavior';
                document.getElementById('reportDescription').value = '';
                document.getElementById('reportStatus').value = 'Pending';
            }
        }

        function hideReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            document.getElementById('reportModal').classList.add('hidden');
        }

        function loadReports() {
            const reportsList = document.getElementById('reportsList');
            reportsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

            const filter = document.getElementById('reportFilter').value;
            let query = reportsRef.orderByChild('timestamp');

            if (filter !== 'all') {
                query = reportsRef.orderByChild('status').equalTo(filter);
            }

            query.on('value', snapshot => {
                const reports = snapshot.val();
                if (!reports) {
                    reportsList.innerHTML = '<p class="text-center py-8 text-gray-500">No reports found</p>';
                    document.getElementById('pendingReportCount').textContent = '0';
                    return;
                }

                let html = '';
                let pendingCount = 0;
                const reportArray = Object.entries(reports);

                // Sort reports by timestamp (newest first)
                reportArray.sort((a, b) => b[1].timestamp - a[1].timestamp);

                reportArray.forEach(([id, report]) => {
                    if (report.status === 'Pending') pendingCount++;

                    html += `
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-medium text-gray-900">Reported: ${report.reportedUser || 'Unknown'}</h3>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${
                                            report.category === 'Behavior' ? 'red' : 
                                            report.category === 'Spam' ? 'orange' : 
                                            report.category === 'Harassment' ? 'purple' : 
                                            report.category === 'Scam' ? 'yellow' : 'gray'}-100 text-${
                                            report.category === 'Behavior' ? 'red' : 
                                            report.category === 'Spam' ? 'orange' : 
                                            report.category === 'Harassment' ? 'purple' : 
                                            report.category === 'Scam' ? 'yellow' : 'gray'}-800">
                                            ${report.category}
                                        </span>
                                        <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${
                                            report.status === 'Pending' ? 'blue' : 
                                            report.status === 'Resolved' ? 'green' : 'gray'}-100 text-${
                                            report.status === 'Pending' ? 'blue' : 
                                            report.status === 'Resolved' ? 'green' : 'gray'}-800">
                                            ${report.status}
                                        </span>
                                        <span class="text-sm text-gray-500">${formatTime(report.timestamp)}</span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="showReportModal('${id}')" class="p-1 text-blue-600 hover:text-blue-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button onclick="deleteReport('${id}')" class="p-1 text-red-600 hover:text-red-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <p class="mt-3 text-gray-600">${report.description || 'No details provided'}</p>
                            ${report.reporterId ? `<p class="mt-2 text-sm text-gray-500">Reported by ${report.reporterName || 'unknown'}</p>` : ''}
                        </div>
                    `;
                });

                reportsList.innerHTML = html;
                document.getElementById('pendingReportCount').textContent = pendingCount;
            });
        }

        function saveReport() {
            const reportId = document.getElementById('reportId').value;
            const reportedUser = document.getElementById('reportUser').value;
            const category = document.getElementById('reportCategory').value;
            const description = document.getElementById('reportDescription').value;
            const status = document.getElementById('reportStatus').value;

            if (!reportedUser || !description) {
                alert('Please fill in all required fields');
                return;
            }

            const reportData = {
                reportedUser,
                category,
                description,
                status,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            if (reportId) {
                // Update existing report
                reportsRef.child(reportId).update(reportData);
            } else {
                // Create new report
                reportData.timestamp = firebase.database.ServerValue.TIMESTAMP;
                reportData.reporterId = currentUser.uid;
                reportData.reporterName = currentUserData.name || currentUser.email.split('@')[0];
                reportsRef.push(reportData);
            }

            hideReportModal();
        }

        function deleteReport(reportId) {
            if (confirm('Are you sure you want to delete this report?')) {
                reportsRef.child(reportId).remove();
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown time';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        // Chat functions
        function loadChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '<div class="text-center py-8 text-gray-500">Loading chat history...</div>';

            chatRef.limitToLast(50).on('value', snapshot => {
                const messages = snapshot.val();
                if (!messages) {
                    chatMessages.innerHTML = '<div class="text-center py-8 text-gray-500">No messages yet</div>';
                    return;
                }

                let html = '';
                const messageArray = Object.entries(messages);

                messageArray.forEach(([id, message]) => {
                    html += `
                        <div class="chat-message mb-3">
                            <div class="flex items-start">
                                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center font-bold text-purple-600 mr-3">
                                    ${message.senderName ? message.senderName.substring(0, 1).toUpperCase() : '?'}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-baseline">
                                        <h4 class="font-medium text-gray-900 mr-2">${message.senderName || 'Unknown'}</h4>
                                        <span class="text-xs text-gray-500">${formatTime(message.timestamp)}</span>
                                    </div>
                                    <p class="text-gray-700">${message.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                chatMessages.innerHTML = html;
                scrollChatToBottom();
            });

            // Handle sending new messages
            document.getElementById('chatInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        }

        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (!message) return;

            const chatMessage = {
                text: message,
                senderId: currentUser.uid,
                senderName: currentUserData.name || currentUser.email.split('@')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            chatRef.push(chatMessage);
            chatInput.value = '';
            scrollChatToBottom();
        }

        function scrollChatToBottom() {
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Finance functions
        function initTransactionModalEvents() {
            document.getElementById('addTransactionBtn').addEventListener('click', function() {
                showTransactionModal();
            });

            document.getElementById('cancelTransactionBtn').addEventListener('click', function() {
                hideTransactionModal();
            });

            document.getElementById('saveTransactionBtn').addEventListener('click', function() {
                saveTransaction();
            });

            document.getElementById('exportFinanceBtn').addEventListener('click', function() {
                exportFinanceData();
            });
        }

        function showTransactionModal(transactionId = null) {
            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('transactionModal').classList.remove('hidden');
            document.getElementById('transactionId').value = transactionId || '';

            // Set default date to today
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];

            if (transactionId) {
                // Load existing transaction data
                transactionsRef.child(transactionId).once('value').then(snapshot => {
                    const transaction = snapshot.val();
                    if (transaction) {
                        document.querySelector(`input[name="transactionType"][value="${transaction.type}"]`).checked = true;
                        document.getElementById('transactionAmount').value = transaction.amount || '';
                                                document.getElementById('transactionDescription').value = transaction.description || '';
                        document.getElementById('transactionCategory').value = transaction.category || 'Event';
                        document.getElementById('transactionDate').value = transaction.date || new Date().toISOString().split('T')[0];
                    }
                });
            } else {
                // Clear form for new transaction
                document.querySelector(`input[name="transactionType"][value="income"]`).checked = true;
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionDescription').value = '';
                document.getElementById('transactionCategory').value = 'Event';
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function hideTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
            document.getElementById('transactionModal').classList.add('hidden');
        }

        function saveTransaction() {
            const transactionId = document.getElementById('transactionId').value;
            const type = document.querySelector('input[name="transactionType"]:checked').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value;
            const category = document.getElementById('transactionCategory').value;
            const date = document.getElementById('transactionDate').value;

            if (!amount || !description) {
                alert('Please fill in all required fields');
                return;
            }

            const transactionData = {
                type,
                amount,
                description,
                category,
                date,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: currentUser .uid
            };

            if (transactionId) {
                // Update existing transaction
                transactionsRef.child(transactionId).update(transactionData);
            } else {
                // Create new transaction
                transactionsRef.push(transactionData);
            }

            hideTransactionModal();
        }

        function exportFinanceData() {
            // Implement export functionality here
            alert('Export functionality is not implemented yet.');
        }

        

	function initProfileEvents() {
    document.getElementById('updateProfileBtn').addEventListener('click', function () {
        const name = document.getElementById('updateProfileName').value;
        const role = document.getElementById('updateProfileRole').value;
        const subDivision = document.getElementById('updateProfileSubDivision')?.value || '';
        const password = document.getElementById('updateProfilePassword').value;

        if (!name || !role) {
            alert('Please fill in both name and role.');
            return;
        }

        const updates = {
            name,
            role,
            subDivision,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
        };

        const userId = currentUser.uid;

        usersRef.child(userId).update(updates).then(() => {
                // Update moderatorsRef name and role too
                moderatorsRef.child(userId).update({
                    name: name,
                    role: role,
                    subDivision: subDivision
                });
    
            if (password) {
                currentUser.updatePassword(password).then(() => {
                    alert('Profile updated and password changed successfully.');
                }).catch(error => {
                    alert('Password update failed: ' + error.message);
                });
            } else {
                alert('Profile updated successfully.');
            }
            // Update currentUserData after successful profile update
            currentUserData.name = name;
            currentUserData.role = role;
            currentUserData.subDivision = subDivision;
            loadProfile(); // Reload profile section to reflect changes
        }).catch(error => {
            alert('Profile update failed: ' + error.message);
        });
    });
}
    
// ‚úÖ Tambahan fungsi: loadFinance
function loadFinance() {
    const transactionsList = document.getElementById('transactionsList');
    const totalBalanceEl = document.getElementById('totalBalance');
    const monthlyIncomeEl = document.getElementById('monthlyIncome');
    const monthlyExpensesEl = document.getElementById('monthlyExpenses');

    transactionsRef.orderByChild('date').off(); transactionsRef.orderByChild('date').on('value', snapshot => {
        const transactions = snapshot.val();
        if (!transactions) {
            transactionsList.innerHTML = '<p class="text-center py-8 text-gray-500">No transactions yet</p>';
            totalBalanceEl.textContent = 'Rp 0';
            monthlyIncomeEl.textContent = 'Rp 0';
            monthlyExpensesEl.textContent = 'Rp 0';
            return;
        }

        const now = new Date();
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();

        let html = '';
        let balance = 0;
        let income = 0;
        let expenses = 0;

        Object.entries(transactions).forEach(([id, trx]) => {
            const trxDate = new Date(trx.date);
            const amount = parseInt(trx.amount) || 0;
            const isIncome = trx.type === 'income';

            if (isIncome) balance += amount;
            else balance -= amount;

            if (trxDate.getMonth() === thisMonth && trxDate.getFullYear() === thisYear) {
                if (isIncome) income += amount;
                else expenses += amount;
            }

            html += `
                <div class="bg-white p-4 shadow rounded-md flex justify-between items-center">
                    <div>
                        <h4 class="font-medium text-gray-900">${trx.description}</h4>
                        <p class="text-sm text-gray-500">${trx.category} ‚Ä¢ ${trx.date}</p>
                    </div>
                    <div class="text-${isIncome ? 'green' : 'red'}-600 font-bold">
                        ${isIncome ? '+' : '-'}Rp ${amount.toLocaleString()}
                    </div>
                </div>
            `;
        });

        transactionsList.innerHTML = html;
        totalBalanceEl.textContent = `Rp ${balance.toLocaleString()}`;
        monthlyIncomeEl.textContent = `Rp ${income.toLocaleString()}`;
        monthlyExpensesEl.textContent = `Rp ${expenses.toLocaleString()}`;
    });
}

// ‚úÖ Tambahan fungsi: loadProfile
// Hapus definisi originalLoadProfile dan override loadProfile yang lama
// const originalLoadProfile = loadProfile; // Simpan referensi ke fungsi asli
// loadProfile = function() { // Override fungsi loadProfile
//     const uid = currentUser.uid;
//     usersRef.child(uid).once('value').then(snapshot => {
//         const user = snapshot.val();
//         if (user) {
//             document.getElementById('profileDisplayName').textContent = user.name || 'Unknown';
//             document.getElementById('profileRoleBadge').textContent = user.role || 'Member';
//             const color = roleColors[user.role] || 'gray';
//             document.getElementById('profileRoleBadge').style.setProperty('--badge-bg', `var(--tw-bg-opacity, 1)`);
//             document.getElementById('profileRoleBadge').style.backgroundColor = `${colorMap(color, 100)}`; // ‚úÖ Menggunakan colorMap
//             document.getElementById('profileRoleBadge').style.color = `${colorMap(color, 800)}`; // ‚úÖ Menggunakan colorMap

//             document.getElementById('profileEmail').textContent = currentUser.email;
//             document.getElementById('profileAvatar').textContent = user.name ? user.name.substring(0, 1).toUpperCase() : '?';
//             document.getElementById('updateProfileName').value = user.name;
//             document.getElementById('updateProfileRole').value = user.role;
//             document.getElementById('updateProfileSubDivision').value = user.subDivision || ''; // Set subDivision value
//             document.getElementById('profileJoinDate').textContent = new Date(user.joinedAt || Date.now()).toLocaleDateString();
//             document.getElementById('profileLastLogin').textContent = new Date().toLocaleString();

//             // Trigger updateSubDivisions to correctly enable/disable and filter sub-division dropdown
//             // Store the initial value in a dataset attribute before calling updateSubDivisions
//             document.getElementById('updateProfileSubDivision').dataset.initialValue = user.subDivision || '';
//             updateSubDivisions('updateProfileRole', 'updateProfileSubDivision');
//         }
//     });
// };

// Definisi loadProfile yang sudah dikonsolidasi dan diperbaiki
function loadProfile() {
    const uid = currentUser.uid;
    usersRef.child(uid).once('value').then(snapshot => {
        const user = snapshot.val();
        if (user) {
            document.getElementById('profileDisplayName').textContent = user.name || 'Unknown';
            document.getElementById('profileRoleBadge').textContent = user.role || 'Member';
            const color = roleColors[user.role] || 'gray';
            document.getElementById('profileRoleBadge').style.setProperty('--badge-bg', `var(--tw-bg-opacity, 1)`);
            document.getElementById('profileRoleBadge').style.backgroundColor = `${colorMap(color, 100)}`;
            document.getElementById('profileRoleBadge').style.color = `${colorMap(color, 800)}`;

            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileAvatar').textContent = user.name ? user.name.substring(0, 1).toUpperCase() : '?';
            document.getElementById('updateProfileName').value = user.name;
            document.getElementById('updateProfileRole').value = user.role;
            document.getElementById('profileJoinDate').textContent = new Date(user.joinedAt || Date.now()).toLocaleDateString();
            document.getElementById('profileLastLogin').textContent = new Date().toLocaleString();

            // Set initial value for subDivision dropdown before calling updateSubDivisions
            const updateProfileSubDivisionEl = document.getElementById('updateProfileSubDivision');
            updateProfileSubDivisionEl.dataset.initialValue = user.subDivision || '';
            
            // Call updateSubDivisions to populate and select the correct sub-division
            updateSubDivisions('updateProfileRole', 'updateProfileSubDivision');
        }
    });
}


</script>
<!-- ‚úÖ PATCHED CHAT, PROFILE, AND SEARCH SECTION START -->
<!-- PATCHED SECTION: Perbaikan fitur chat, profile, dan status online -->
<script>
// Tambahkan di bagian bawah script utama, atau setelah definisi fungsi setupUserPresence()

// This setupUserPresence is already defined above, avoid re-definition
/*
function setupUserPresence() {
    const userId = currentUser.uid;
    const userStatusRef = db.ref('status/' + userId);
    const connectedRef = db.ref('.info/connected');

    connectedRef.on('value', function(snapshot) {
        if (snapshot.val() === true) {
            userStatusRef.onDisconnect().set({
                status: 'offline',
                lastChanged: firebase.database.ServerValue.TIMESTAMP
            });

            userStatusRef.set({
                status: 'online',
                lastChanged: firebase.database.ServerValue.TIMESTAMP
            });

            // Update lastSeen moderator setiap 60 detik
            setInterval(() => {
                moderatorsRef.child(userId).update({
                    lastSeen: new Date().toISOString()
                });
            }, 60000);
        }
    });
}
*/

// Perbarui loadProfile jadi realtime
// Hapus definisi loadProfileRealtime yang duplikat
/*
function loadProfileRealtime() {
    const uid = currentUser.uid;
    usersRef.child(uid).on('value', snapshot => {
        const user = snapshot.val();
        if (user) {
            document.getElementById('profileDisplayName').textContent = user.name || 'Unknown';
            document.getElementById('profileRoleBadge').textContent = user.role || 'Member';
            const color = roleColors[user.role] || 'gray';
            document.getElementById('profileRoleBadge').style.setProperty('--badge-bg', `var(--tw-bg-opacity, 1)`);
            document.getElementById('profileRoleBadge').style.backgroundColor = `${colorMap(color, 100)}`;
            document.getElementById('profileRoleBadge').style.color = `${colorMap(color, 800)}`;

            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileAvatar').textContent = user.name ? user.name.substring(0, 1).toUpperCase() : '?';
            document.getElementById('updateProfileName').value = user.name;
            document.getElementById('updateProfileRole').value = user.role;
            document.getElementById('profileJoinDate').textContent = new Date(user.joinedAt || Date.now()).toLocaleDateString();
            document.getElementById('profileLastLogin').textContent = new Date().toLocaleString();
        }
    });
}
*/

// Gunakan saat ganti tab ke profile atau saat login sukses
// loadProfileRealtime(); // Ini akan memanggil loadProfile yang sudah dikonsolidasi

// Tambahkan update ke moderatorsRef saat user update profil
// This saveProfile is for the initial profile completion, not the update profile section
function saveProfileInitial() { 
    const name = document.getElementById('profileName').value;
    const role = document.getElementById('profileRole').value;
    const subDivision = document.getElementById('profileSubDivision')?.value || '';
    const password = document.getElementById('profilePassword').value;

    if (!name || !role) {
        alert('Please fill in all required fields');
        return;
    }

    const updates = {
        name: name,
        role: role,
        subDivision: subDivision,
        profileComplete: true,
        joinedAt: new Date().toISOString()
    };

    const userId = currentUser.uid;

    usersRef.child(userId).update(updates).then(() => {
        moderatorsRef.child(userId).update({
            name: name,
            role: role,
            subDivision: subDivision,
            joinedAt: updates.joinedAt,
            lastSeen: new Date().toISOString()
        });

        if (password) {
            currentUser.updatePassword(password).catch(error => {
                console.error('Error updating password:', error);
            });
        }
        currentUserData = { ...currentUserData, ...updates }; // Update global user data
        document.getElementById('authModal').classList.remove('flex');
        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loadAppData();
    });
}

// Override the saveProfile function with the initial one
document.getElementById('saveProfileBtn').removeEventListener('click', saveProfile);
document.getElementById('saveProfileBtn').addEventListener('click', saveProfileInitial);


// Gunakan user data terbaru saat kirim pesan chat
function sendMessage() {
    const message = document.getElementById('chatInput').value.trim();
    if (!message) return;

    usersRef.child(currentUser.uid).once('value').then(snapshot => {
        const user = snapshot.val();
        const name = user.name || 'Unknown';
        const role = user.role || 'Member';

        chatRef.push({
            uid: currentUser.uid,
            name: name,
            role: role,
            message: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        document.getElementById('chatInput').value = '';
    });
}

// Ganti event click tombol kirim chat
// document.getElementById('sendChatBtn').addEventListener('click', sendMessage);
</script>
<script>
// üîç Fitur pencarian moderator berdasarkan nama
document.getElementById('moderatorSearch').addEventListener('input', function () {
    const query = this.value.toLowerCase();

    const moderatorCards = document.querySelectorAll('#moderatorsList > div');
    moderatorCards.forEach(card => {
        const name = card.querySelector('h3')?.textContent.toLowerCase() || '';
        if (name.includes(query)) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
});
</script>
<!-- ‚úÖ PATCHED CHAT, PROFILE, AND SEARCH SECTION END -->
<!-- ‚úÖ PATCHED CHAT & PROFILE SECTION START -->
<!-- PATCHED SECTION: Perbaikan fitur chat, profile, dan status online -->
<script>
// Tambahkan di bagian bawah script utama, atau setelah definisi fungsi setupUserPresence()

// This setupUserPresence is already defined above, avoid re-definition
/*
function setupUserPresence() {
    const userId = currentUser.uid;
    const userStatusRef = db.ref('status/' + userId);
    const connectedRef = db.ref('.info/connected');

    connectedRef.on('value', function(snapshot) {
        if (snapshot.val() === true) {
            userStatusRef.onDisconnect().set({
                status: 'offline',
                lastChanged: firebase.database.ServerValue.TIMESTAMP
            });

            userStatusRef.set({
                status: 'online',
                lastChanged: firebase.database.ServerValue.TIMESTAMP
            });

            // Update lastSeen moderator setiap 60 detik
            setInterval(() => {
                moderatorsRef.child(userId).update({
                    lastSeen: new Date().toISOString()
                });
            }, 60000);
        }
    });
}
*/

// Perbarui loadProfile jadi realtime
// This loadProfileRealtime is already defined above, avoid re-definition
/*
function loadProfileRealtime() {
    const uid = currentUser.uid;
    usersRef.child(uid).on('value', snapshot => {
        const user = snapshot.val();
        if (user) {
            document.getElementById('profileDisplayName').textContent = user.name || 'Unknown';
            document.getElementById('profileRoleBadge').textContent = user.role || 'Member';
            const color = roleColors[user.role] || 'gray';
            document.getElementById('profileRoleBadge').style.setProperty('--badge-bg', `var(--tw-bg-opacity, 1)`);
            document.getElementById('profileRoleBadge').style.backgroundColor = `${colorMap(color, 100)}`;
            document.getElementById('profileRoleBadge').style.color = `${colorMap(color, 800)}`;

            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileAvatar').textContent = user.name ? user.name.substring(0, 1).toUpperCase() : '?';
            document.getElementById('updateProfileName').value = user.name;
            document.getElementById('updateProfileRole').value = user.role;
            document.getElementById('profileJoinDate').textContent = new Date(user.joinedAt || Date.now()).toLocaleDateString();
            document.getElementById('profileLastLogin').textContent = new Date().toLocaleString();
        }
    });
}
*/

// Gunakan saat ganti tab ke profile atau saat login sukses
// loadProfileRealtime();

// Tambahkan update ke moderatorsRef saat user update profil
// This saveProfile is already defined above, avoid re-definition
/*
function saveProfile() {
    const name = document.getElementById('profileName').value;
    const role = document.getElementById('profileRole').value;
    const password = document.getElementById('profilePassword').value;

    if (!name || !role) {
        alert('Please fill in all required fields');
        return;
    }

    const updates = {
        name: name,
        role: role,
        profileComplete: true
    };

    const userId = currentUser.uid;

    usersRef.child(userId).update(updates).then(() => {
                // Update moderatorsRef name and role too
                moderatorsRef.child(userId).update({
                    name: name,
                    role: role
                });
    
        moderatorsRef.child(userId).update({
            name: name,
            role: role,
            lastSeen: new Date().toISOString()
        });

        if (password) {
            currentUser.updatePassword(password).catch(error => {
                console.error('Error updating password:', error);
            });
        }

        document.getElementById('authModal').classList.remove('flex');
        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        loadAppData();
    });
}
*/

// Gunakan user data terbaru saat kirim pesan chat
// This sendMessage is already defined above, avoid re-definition
/*
function sendMessage() {
    const message = document.getElementById('chatInput').value.trim();
    if (!message) return;

    usersRef.child(currentUser.uid).once('value').then(snapshot => {
        const user = snapshot.val();
        const name = user.name || 'Unknown';
        const role = user.role || 'Member';

        chatRef.push({
            uid: currentUser.uid,
            name: name,
            role: role,
            message: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        document.getElementById('chatInput').value = '';
    });
}
*/

// Ganti event click tombol kirim chat
// document.getElementById('sendChatBtn').addEventListener('click', sendMessage);


document.getElementById('exportFinanceBtn').addEventListener('click', function() {
    transactionsRef.once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data) {
            alert('No transactions to export.');
            return;
        }

        const rows = [['Description', 'Category', 'Date', 'Amount', 'Type']];
        Object.values(data).forEach(trx => {
            rows.push([trx.description, trx.category, trx.date, trx.amount, trx.type]);
        });

        let csvContent = 'data:text/csv;charset=utf-8,' + rows.map(e => e.join(',')).join('\n');
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', 'finance_export.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>
<!-- ‚úÖ PATCHED CHAT & PROFILE SECTION END -->
<script>
// === Duplication Guard Patch ===
(function() {
  const once = fnName => {
    const original = window[fnName];
    if (typeof original !== 'function') return;
    let done = false;
    window[fnName] = function() {
      if (done) return;
      done = true;
      return original.apply(this, arguments);
    };
  };
  ['initEventModalEvents','initReportModalEvents','initTransactionModalEvents','initAuthEvents','initTabEvents'].forEach(once);
})();</script><script>
// === Presence Accuracy Patch ===
(function(){
  window.setupUserPresence = function () {
    const userId = currentUser.uid;
    const userStatusRef = db.ref('status/' + userId);
    const modRef = moderatorsRef.child(userId);
    const connectedRef = db.ref('.info/connected');

    const setLastSeen = () => {
      const nowIso = new Date().toISOString();
      modRef.update({ lastSeen: nowIso });
    };

    // Listen connection
    connectedRef.on('value', snap => {
      if (snap.val() === true) {
        // When connected
        userStatusRef.onDisconnect().set({
          status: 'offline',
          lastChanged: firebase.database.ServerValue.TIMESTAMP
        });

        userStatusRef.set({
          status: 'online',
          lastChanged: firebase.database.ServerValue.TIMESTAMP
        });

        // Immediately mark online + lastSeen
        modRef.update({ status: 'online', lastSeen: new Date().toISOString() });
        // Keep refreshing lastSeen every 20s for better accuracy
        setLastSeen();
        window._lastSeenInterval && clearInterval(window._lastSeenInterval);
        window._lastSeenInterval = setInterval(setLastSeen, 20000);
      } else {
        // Disconnected locally ‚Äì will be handled by onDisconnect on server side too
        modRef.update({ status: 'offline', lastSeen: new Date().toISOString() });
      }
    });

    // Mirror /status node changes back to moderators list (in case other clients need it)
    userStatusRef.on('value', snap => {
      const data = snap.val() || {};
      modRef.update({ status: data.status || 'offline' });
    });
  };
})();</script>
<script>
// Firebase sudah diinisialisasi sebelumnya

const ticketTypeOptions = {
  Income: ["Membership Discord", "Premium Class", "Competition/Tournament"],
  Expense: ["Design Service", "Guest Speaker Invitation", "Server Needs", "Rewards/Prizes"]
};

document.addEventListener('DOMContentLoaded', function () {
  const categoryEl = document.getElementById('category');
  const typeEl = document.getElementById('ticketType');
  const form = document.getElementById('ticketForm');

  categoryEl.addEventListener('change', function () {
    const selected = this.value;
    typeEl.innerHTML = '<option value="">Select Ticket Type</option>';

    if (selected && ticketTypeOptions[selected]) {
      typeEl.disabled = false;
      ticketTypeOptions[selected].forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        typeEl.appendChild(option);
      });
    } else {
      typeEl.disabled = true;
    }
  });

  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const buyerName = document.getElementById('buyerName').value;
    const category = categoryEl.value;
    const ticketType = typeEl.value;
    const purchaseDate = document.getElementById('purchaseDate').value;
    const price = parseInt(document.getElementById('price').value);

    const newTicketRef = db.ref('tickets').push();
    const ticketData = {
      id: newTicketRef.key,
      buyerName,
      category,
      ticketType,
      purchaseDate,
      price
    };

    newTicketRef.set(ticketData);

    db.ref('transactions').push({
      type: category.toLowerCase(),
      amount: price,
      description: ticketType,
      category: "Tiketing",
      date: purchaseDate
    });

    form.reset();
    typeEl.disabled = true;
  });

  db.ref('tickets').on('value', (snapshot) => {
    const list = document.getElementById('ticketList');
    list.innerHTML = '';
    snapshot.forEach(child => {
      const ticket = child.val();
      const div = document.createElement('div');
      div.className = "p-4 bg-white rounded shadow";
      div.innerHTML = `
        <p><strong>Buyer:</strong> ${ticket.buyerName}</p>
        <p><strong>Category:</strong> ${ticket.category}</p>
        <p><strong>Type:</strong> ${ticket.ticketType}</p>
        <p><strong>Date:</strong> ${ticket.purchaseDate}</p>
        <p><strong>Price:</strong> Rp ${ticket.price}</p>
      `;
      list.appendChild(div);
    });
  });
});
</script>

<script>
function updateSubDivisions(roleSelectId, subDivSelectId) {
  const role = document.getElementById(roleSelectId).value;
  const subDiv = document.getElementById(subDivSelectId);
  
  // Clear existing options except the first one
  subDiv.innerHTML = '<option value="">Pilih Sub-Divisi</option>';
  
  if (role === "Founder" || role === "Co-Founder" || role === "") {
    subDiv.value = "";
    subDiv.disabled = true;
    return;
  }

  const availableSubdivisions = subDivisionOptions[role] || [];
  availableSubdivisions.forEach(item => {
    const option = document.createElement('option');
    option.value = item;
    option.textContent = item;
    option.setAttribute('data-role', role); // Keep data-role for consistency
    subDiv.appendChild(option);
  });

  subDiv.disabled = false;

  // If there's a pre-selected value (e.g., from user data), try to set it
  // This assumes `updateProfileSubDivision` might have a value from `user.subDivision`
  if (subDiv.dataset.initialValue) {
      subDiv.value = subDiv.dataset.initialValue;
      delete subDiv.dataset.initialValue; // Clear after setting
  } else if (currentUserData && currentUserData.subDivision && currentUserData.role === role) {
      // If current user's subDivision matches the selected role, pre-select it
      subDiv.value = currentUserData.subDivision;
  } else {
      subDiv.value = ""; // Reset if no matching sub-division
  }
}

// Override loadProfile to correctly set initial subDivision value
// const originalLoadProfile = loadProfile; // Sudah didefinisikan di atas
// loadProfile = function() { // Sudah didefinisikan di atas
//     originalLoadProfile(); // Call the original loadProfile first
//     const uid = currentUser.uid;
//     usersRef.child(uid).once('value').then(snapshot => {
//         const user = snapshot.val();
//         if (user && user.subDivision) {
//             // Store the initial value in a dataset attribute
//             document.getElementById('updateProfileSubDivision').dataset.initialValue = user.subDivision;
//             // Then call updateSubDivisions to populate and select
//             updateSubDivisions('updateProfileRole', 'updateProfileSubDivision');
//         }
//     });
// };

// Fungsi baru untuk menampilkan/menyembunyikan sub-divisi dan memuat checkbox
function toggleSubdivisions(departmentName, isChecked, eventId = null) {
    const subDivContainer = document.getElementById(`subdivisions_for_${departmentName}`);
    if (isChecked) {
        subDivContainer.classList.remove('hidden');
        loadSubdivisionCheckboxes(departmentName, {}, eventId); // Load empty or existing subdivisions
    } else {
        subDivContainer.classList.add('hidden');
        subDivContainer.innerHTML = ''; // Clear checkboxes when department is unchecked
    }
}

// Fungsi baru untuk memuat checkbox sub-divisi
function loadSubdivisionCheckboxes(departmentName, existingSubdivisions = {}, eventId = null) {
    const subDivContainer = document.getElementById(`subdivisions_for_${departmentName}`);
    subDivContainer.innerHTML = ''; // Clear before adding

    const availableSubdivisions = subDivisionOptions[departmentName] || [];
    if (availableSubdivisions.length === 0) {
        subDivContainer.innerHTML = '<p class="text-xs text-gray-500">No specific subdivisions for this department.</p>';
        return;
    }

    availableSubdivisions.forEach(subDiv => {
        const isSubDivChecked = existingSubdivisions[subDiv];
        subDivContainer.innerHTML += `
            <label class="inline-flex items-center">
                <input type="checkbox" id="subdiv_${departmentName}_${subDiv}" value="${subDiv}" ${isSubDivChecked ? 'checked' : ''} class="h-4 w-4 text-gray-600 rounded">
                <span class="ml-2 text-xs text-gray-600">${subDiv}</span>
            </label>
        `;
    });
}

</script>

</body>
</html>
<script>
function colorMap(color, level) {
    const colors = {
        red:    {100: '#fee2e2', 800: '#991b1b'},
        orange: {100: '#ffedd5', 800: '#9a3412'},
        yellow: {100: '#fef9c3', 800: '#a16207'},
        green:  {100: '#d1fae5', 800: '#065f46'},
        blue:   {100: '#dbeafe', 800: '#1e40af'},
        purple: {100: '#ede9fe', 800: '#5b21b6'},
        indigo: {100: '#e0e7ff', 800: '#3730a3'},
        gray:   {100: '#f3f4f6', 800: '#374151'}
    };
    return colors[color]?.[level] || '#e5e7eb';
}
</script>
