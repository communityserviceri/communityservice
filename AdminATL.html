<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | Community Service</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for modals and progress bars */
    .modal {
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease-in-out;
    }
    .modal.active {
        opacity: 1;
        visibility: visible;
    }
    .progress-bar {
        height: 8px;
        border-radius: 4px;
        background-color: #e0e0e0;
    }
    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .nested-progress-container {
        margin-left: 1rem;
        border-left: 2px solid #e0e0e0;
        padding-left: 1rem;
    }
    .department-item, .subdivision-item {
        background-color: #f9fafb;
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .task-item {
        background-color: #ffffff;
        padding: 0.5rem;
        border-radius: 0.375rem;
        margin-bottom: 0.25rem;
        border: 1px solid #e5e7eb;
    }
  </style>
  <script type="module">
    // Firebase Finance Integration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCdl3XJ-eUz8BELLaSOXeZFpg7FLDFk7l4",
      authDomain: "community-service-f4540.firebaseapp.com",
      databaseURL: "https://community-service-f4540-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "community-service-f4540",
      storageBucket: "community-service-f4540.appspot.com",
      messagingSenderId: "610712310542",
      appId: "1:610712310542:web:12536a7c23d0b41db03d5f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Firebase References (disesuaikan dengan code (8).html)
    const usersRef = ref(db, 'users');
    const moderatorsRef = ref(db, 'moderators');
    const eventsRef = ref(db, 'events');
    const transactionsRef = ref(db, 'transactions');
    const statusRef = ref(db, 'status'); // Untuk status online/offline
    const reportsRef = ref(db, 'reports'); // NEW: For reports monitoring

    // Role and Sub-Division Options (from code (8).html)
    const roleColors = {
        "Founder": "red",
        "Co-Founder": "orange",
        "Education": "indigo",
        "Moderation": "blue",
        "Events": "green",
        "Creative": "purple",
        "Technology": "teal",
        "Finance": "yellow"
    };

    const subDivisionOptions = {
        "Education": ["Koordinator Edukasi", "Mentor", "Pemateri", "Notulen"],
        "Moderation": ["Head Moderator", "Moderator", "Helper", "Support Staff"],
        "Events": ["Event Coordinator", "MC", "Host", "Giveaway Staff"],
        "Creative": ["Content Lead", "Designer", "Editor", "Dokumentator", "Social Media"],
        "Technology": ["Tech Lead", "Bot Developer", "Web Tools Support", "Database Admin"],
        "Finance": ["Bendahara", "Pembukuan", "Donasi", "Anggaran", "Laporan Keuangan"]
    };

    // --- Finance Functions ---
    function loadFinance() {
      const transactionsList = document.getElementById('transactionsList');
      const totalBalanceEl = document.getElementById('totalBalance');
      const monthlyIncomeEl = document.getElementById('monthlyIncome');
      const monthlyExpensesEl = document.getElementById('monthlyExpenses');

      onValue(transactionsRef, snapshot => {
        const transactions = snapshot.val();
        if (!transactions) {
          transactionsList.innerHTML = '<p class="text-center py-8 text-gray-500">No transactions yet</p>';
          totalBalanceEl.textContent = 'Rp 0';
          monthlyIncomeEl.textContent = 'Rp 0';
          monthlyExpensesEl.textContent = 'Rp 0';
          return;
        }

        const now = new Date();
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();

        let html = '';
        let balance = 0;
        let income = 0;
        let expenses = 0;

        // Sort transactions by date (newest first)
        const sortedTransactions = Object.entries(transactions).sort((a, b) => {
            const dateA = new Date(a[1].date);
            const dateB = new Date(b[1].date);
            return dateB - dateA;
        });

        sortedTransactions.forEach(([id, trx]) => {
          const trxDate = new Date(trx.date);
          const amount = parseInt(trx.amount) || 0;
          const isIncome = trx.type === 'income';

          if (isIncome) balance += amount;
          else balance -= amount;

          if (trxDate.getMonth() === thisMonth && trxDate.getFullYear() === thisYear) {
            if (isIncome) income += amount;
            else expenses += amount;
          }

          html += `
            <div class="bg-white p-4 shadow rounded-md flex justify-between items-center">
              <div>
                <h4 class="font-medium text-gray-900">${trx.description}</h4>
                <p class="text-sm text-gray-500">${trx.category} • ${trx.date}</p>
              </div>
              <div class="text-${isIncome ? 'green' : 'red'}-600 font-bold">
                ${isIncome ? '+' : '-'}Rp ${amount.toLocaleString()}
              </div>
            </div>
          `;
        });

        transactionsList.innerHTML = html;
        totalBalanceEl.textContent = `Rp ${balance.toLocaleString()}`;
        monthlyIncomeEl.textContent = `Rp ${income.toLocaleString()}`;
        monthlyExpensesEl.textContent = `Rp ${expenses.toLocaleString()}`;

        // Update Finance Chart (Dashboard)
        updateFinanceChart(income, expenses);
      });
    }

    let financeChartInstance = null;
    function updateFinanceChart(income, expenses) {
        const financeCtx = document.getElementById('financeChart').getContext('2d');
        if (financeChartInstance) {
            financeChartInstance.destroy();
        }
        financeChartInstance = new Chart(financeCtx, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expenses'],
                datasets: [{
                    label: 'Monthly Overview',
                    data: [income, expenses],
                    backgroundColor: ['#10b981', '#ef4444'], // green for income, red for expenses
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // --- Moderator Functions ---
    let roleChartInstance = null;
    function loadModerators() {
      const roles = {};
      const listContainer = document.getElementById("moderatorList");
      listContainer.innerHTML = "";

      onValue(moderatorsRef, (snapshot) => {
        const moderators = snapshot.val();
        if (!moderators) {
            listContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No moderators found</p>';
            if (roleChartInstance) roleChartInstance.destroy();
            return;
        }

        // Clear previous roles data
        for (const key in roles) { delete roles[key]; }

        const moderatorArray = Object.entries(moderators);

        // Fetch status for each moderator
        const moderatorCardsPromises = moderatorArray.map(([id, mod]) => {
            return new Promise(resolve => {
                onValue(ref(db, `status/${id}`), (statusSnap) => {
                    const status = statusSnap.val();
                    const isOnline = status && status.status === 'online';
                    resolve({ id, mod, isOnline });
                }, { onlyOnce: true }); // Use onlyOnce to avoid re-rendering on every status change
            });
        });

        Promise.all(moderatorCardsPromises).then(moderatorData => {
            listContainer.innerHTML = ""; // Clear list before re-populating

            moderatorData.forEach(({ id, mod, isOnline }) => {
                const role = mod.role || 'Lainnya';
                roles[role] = (roles[role] || 0) + 1;

                const statusColor = isOnline ? 'green' : 'gray';
                const statusText = isOnline ? 'Online' : 'Offline';

                const div = document.createElement("div");
                div.className = `p-4 bg-white rounded-lg shadow moderator-card relative`;
                div.dataset.name = mod.name || "Unknown";
                div.dataset.departemen = mod.role || "Unknown";
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-${statusColor}-100 flex items-center justify-center font-bold text-${statusColor}-600 mr-3">
                                ${mod.name ? mod.name.substring(0, 1).toUpperCase() : '?'}
                            </div>
                            <div>
                                <strong class="text-gray-800">${mod.name || 'Unknown'}</strong><br>
                                <small class="text-gray-600">${mod.role || 'Member'} ${mod.subDivision ? ' - ' + mod.subDivision : ''}</small><br>
                                <span class="text-xs text-${statusColor}-500">${statusText}</span>
                            </div>
                        </div>
                        <button onclick="window.openEditModeratorModal('${id}', '${mod.name}', '${mod.role}', '${mod.subDivision}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Edit</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });

            // Update Role Chart (Dashboard)
            const roleCtx = document.getElementById('roleChart').getContext('2d');
            if (roleChartInstance) {
                roleChartInstance.destroy();
            }
            roleChartInstance = new Chart(roleCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(roles),
                    datasets: [{
                        data: Object.values(roles),
                        backgroundColor: ['#3b82f6', '#6366f1', '#facc15', '#10b981', '#f472b6', '#8b5cf6', '#06b6d4', '#f97316']
                    }]
                },
                options: { responsive: true }
            });
        });
      });
    }

    // --- Edit Moderator Modal Functions ---
    window.openEditModeratorModal = function(uid, name, role, subDivision) {
        document.getElementById('editModeratorModal').classList.add('active');
        document.getElementById('editModeratorModal').classList.remove('hidden');
        document.getElementById('editModeratorUid').value = uid;
        document.getElementById('editModeratorName').value = name;
        document.getElementById('editModeratorRole').value = role;

        // Populate sub-division dropdown based on selected role
        window.updateSubDivisions('editModeratorRole', 'editModeratorSubDivision', subDivision);
    }

    window.closeEditModeratorModal = function() {
        document.getElementById('editModeratorModal').classList.remove('active');
        document.getElementById('editModeratorModal').classList.add('hidden');
    }

    window.saveModeratorChanges = function() {
        const uid = document.getElementById('editModeratorUid').value;
        const name = document.getElementById('editModeratorName').value;
        const role = document.getElementById('editModeratorRole').value;
        const subDivision = document.getElementById('editModeratorSubDivision').value;

        if (!name || !role) {
            alert('Nama dan Departemen tidak boleh kosong!');
            return;
        }

        const updates = {
            name: name,
            role: role,
            subDivision: subDivision
        };

        // Update both users and moderators nodes
        update(ref(db, `users/${uid}`), updates)
            .then(() => update(ref(db, `moderators/${uid}`), updates))
            .then(() => {
                alert('Perubahan moderator berhasil disimpan!');
                window.closeEditModeratorModal();
                loadModerators(); // Reload moderator list to reflect changes
            })
            .catch(error => {
                alert('Gagal menyimpan perubahan: ' + error.message);
            });
    }

    // Function to update sub-division dropdown based on role selection
    window.updateSubDivisions = function(roleSelectId, subDivSelectId, initialValue = '') {
        const role = document.getElementById(roleSelectId).value;
        const subDiv = document.getElementById(subDivSelectId);

        subDiv.innerHTML = '<option value="">Pilih Sub-Divisi</option>'; // Clear existing options

        if (role === "Founder" || role === "Co-Founder" || role === "") {
            subDiv.value = "";
            subDiv.disabled = true;
            return;
        }

        const availableSubdivisions = subDivisionOptions[role] || [];
        availableSubdivisions.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            subDiv.appendChild(option);
        });

        subDiv.disabled = false;

        // Set initial value if provided
        if (initialValue) {
            subDiv.value = initialValue;
        } else {
            subDiv.value = ""; // Reset if no matching sub-division
        }
    }

    // --- Event/Task Functions ---
    let eventsChartInstance = null;
    function loadEventsSummary() {
        const eventsSummaryList = document.getElementById('eventsSummaryList');
        eventsSummaryList.innerHTML = '<p class="text-center py-8 text-gray-500">Loading events...</p>';

        onValue(eventsRef, (snapshot) => {
            const events = snapshot.val();
            if (!events) {
                eventsSummaryList.innerHTML = '<p class="text-center py-8 text-gray-500">No events found</p>';
                if (eventsChartInstance) eventsChartInstance.destroy();
                return;
            }

            let html = '';
            let totalEvents = 0;
            let completedEvents = 0;
            let inProgressEvents = 0;

            Object.entries(events).forEach(([id, event]) => {
                totalEvents++;
                const progress = event.progress ? (event.progress * 100).toFixed(0) : 0;
                const progressColor = progress == 100 ? 'green' : 'blue';

                if (progress == 100) completedEvents++;
                else if (progress > 0 && progress < 100) inProgressEvents++;

                html += `
                    <div class="bg-white p-4 rounded-lg shadow cursor-pointer hover:bg-gray-50" onclick="window.openEventDetailsModal('${id}')">
                        <h4 class="font-medium text-gray-900">${event.title}</h4>
                        <p class="text-sm text-gray-500">Date: ${new Date(event.executionDateTime).toLocaleDateString()}</p>
                        <div class="mt-2">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-${progressColor}-800">Progress: ${progress}%</span>
                            </div>
                            <div class="progress-bar h-2 bg-gray-200 rounded-full">
                                <div class="progress-fill h-full bg-${progressColor}-500 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            eventsSummaryList.innerHTML = html;

            // Update Events Chart (Dashboard)
            const eventsCtx = document.getElementById('eventsChart').getContext('2d');
            if (eventsChartInstance) {
                eventsChartInstance.destroy();
            }
            eventsChartInstance = new Chart(eventsCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [completedEvents, inProgressEvents, totalEvents - completedEvents - inProgressEvents],
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444'], // green, blue, red
                    }]
                },
                options: { responsive: true }
            });
        });
    }

    // --- Event Details Modal Functions ---
    window.openEventDetailsModal = function(eventId) {
        document.getElementById('eventDetailsModal').classList.add('active');
        document.getElementById('eventDetailsModal').classList.remove('hidden');

        // Store current eventId to detach listener later
        document.getElementById('eventDetailsModal').dataset.currentEventId = eventId;

        onValue(ref(db, `events/${eventId}`), (snapshot) => {
            const event = snapshot.val();
            if (!event) {
                alert('Event not found.');
                window.closeEventDetailsModal();
                return;
            }

            document.getElementById('detailEventTitle').textContent = event.title;
            document.getElementById('detailEventDescription').textContent = event.description;
            document.getElementById('detailEstimatedBudget').textContent = `Rp ${event.estimatedBudget ? event.estimatedBudget.toLocaleString() : '0'}`;
            document.getElementById('detailExecutionDateTime').textContent = new Date(event.executionDateTime).toLocaleString();

            const overallProgress = event.progress ? (event.progress * 100).toFixed(0) : 0;
            document.getElementById('detailEventProgress').textContent = `${overallProgress}%`;
            document.getElementById('detailEventProgressBar').style.width = `${overallProgress}%`;
            document.getElementById('detailEventProgressBar').className = `progress-fill bg-${overallProgress == 100 ? 'green' : 'blue'}-500`;

            const departmentsListEl = document.getElementById('eventDetailsDepartmentsList');
            departmentsListEl.innerHTML = ''; // Clear previous content

            const departments = event.departments || {};
            for (const deptName of Object.keys(departments)) {
                const department = departments[deptName];
                const deptProgress = department.progress ? (department.progress * 100).toFixed(0) : 0;
                const deptProgressColor = deptProgress == 100 ? 'green' : 'blue';

                let departmentHtml = `
                    <div class="department-item">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-lg text-gray-800">${deptName}</h4>
                            <span class="text-sm font-medium text-${deptProgressColor}-800">${deptProgress}%</span>
                        </div>
                        <div class="progress-bar mb-3">
                            <div class="progress-fill bg-${deptProgressColor}-500" style="width: ${deptProgress}%"></div>
                        </div>
                        <div class="nested-progress-container space-y-3" id="subdivisions-list-${deptName}">
                            <!-- Subdivisions will be loaded here -->
                        </div>
                    </div>
                `;
                departmentsListEl.innerHTML += departmentHtml;

                const subdivisionsListEl = document.getElementById(`subdivisions-list-${deptName}`);
                const subdivisions = department.subdivisions || {};

                for (const subDivName of Object.keys(subdivisions)) {
                    const subdivision = subdivisions[subDivName];
                    const subDivProgress = subdivision.progress ? (subdivision.progress * 100).toFixed(0) : 0;
                    const subDivProgressColor = subDivProgress == 100 ? 'green' : 'blue';

                    let subdivisionHtml = `
                        <div class="subdivision-item">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-md text-gray-700">${subDivName}</h5>
                                <span class="text-sm font-medium text-${subDivProgressColor}-800">${subDivProgress}%</span>
                            </div>
                            <div class="progress-bar mb-3">
                                <div class="progress-fill bg-${subDivProgressColor}-500" style="width: ${subDivProgress}%"></div>
                            </div>
                            <div class="nested-progress-container space-y-2" id="tasks-list-${deptName}-${subDivName}">
                                <!-- Tasks will be loaded here -->
                            </div>
                        </div>
                    `;
                    subdivisionsListEl.innerHTML += subdivisionHtml;

                    const tasksListEl = document.getElementById(`tasks-list-${deptName}-${subDivName}`);
                    const tasks = subdivision.tasks || {};

                    for (const taskId of Object.keys(tasks)) {
                        const task = tasks[taskId];
                        const taskStatusColor = task.status === 'complete' ? 'green' : 'orange';

                        tasksListEl.innerHTML += `
                            <div class="task-item">
                                <div>
                                    <p class="font-normal text-gray-800">${task.title}</p>
                                    <p class="text-xs text-gray-500">PIC: ${task.PICName || 'Unknown'} | Status: <span class="font-medium text-${taskStatusColor}-600">${task.status}</span></p>
                                </div>
                            </div>
                        `;
                    }
                }
            }
        });
    }

    window.closeEventDetailsModal = function() {
        document.getElementById('eventDetailsModal').classList.remove('active');
        document.getElementById('eventDetailsModal').classList.add('hidden');
        // Detach listener when modal is closed to prevent memory leaks
        const currentEventId = document.getElementById('eventDetailsModal').dataset.currentEventId;
        if (currentEventId) {
            onValue(ref(db, `events/${currentEventId}`), () => {}, { onlyOnce: true }); // Detach listener
            delete document.getElementById('eventDetailsModal').dataset.currentEventId; // Clear stored ID
        }
    }

    // --- Reports Functions ---
    window.loadReports = function() {
        const reportsList = document.getElementById('reportsList');
        reportsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

        const filter = document.getElementById('reportFilter').value;
        let reportsQuery = reportsRef;

        if (filter !== 'all') {
            reportsQuery = query(reportsRef, orderByChild('status'), equalTo(filter));
        } else {
            reportsQuery = query(reportsRef, orderByChild('timestamp')); // Order by timestamp for 'all'
        }

        onValue(reportsQuery, snapshot => {
            const reports = snapshot.val();
            if (!reports) {
                reportsList.innerHTML = '<p class="text-center py-8 text-gray-500">No reports found</p>';
                document.getElementById('pendingReportCount').textContent = '0';
                return;
            }

            let html = '';
            let pendingCount = 0;
            const reportArray = Object.entries(reports);

            // Sort reports by timestamp (newest first)
            reportArray.sort((a, b) => b[1].timestamp - a[1].timestamp);

            reportArray.forEach(([id, report]) => {
                if (report.status === 'Pending') pendingCount++;

                const categoryColor = 
                    report.category === 'Behavior' ? 'red' : 
                    report.category === 'Spam' ? 'orange' : 
                    report.category === 'Harassment' ? 'purple' : 
                    report.category === 'Scam' ? 'yellow' : 'gray';
                
                const statusColor = 
                    report.status === 'Pending' ? 'blue' : 
                    report.status === 'Resolved' ? 'green' : 'gray';

                html += `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900">Reported: ${report.reportedUser || 'Unknown'}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${categoryColor}-100 text-${categoryColor}-800">
                                        ${report.category}
                                    </span>
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                        ${report.status}
                                    </span>
                                    <span class="text-sm text-gray-500">${formatTime(report.timestamp)}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="window.openReportModal('${id}')" class="p-1 text-blue-600 hover:text-blue-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="window.deleteReport('${id}')" class="p-1 text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <p class="mt-3 text-gray-600">${report.description || 'No details provided'}</p>
                        ${report.reporterId ? `<p class="mt-2 text-sm text-gray-500">Reported by ${report.reporterName || 'unknown'}</p>` : ''}
                    </div>
                `;
            });

            reportsList.innerHTML = html;
            document.getElementById('pendingReportCount').textContent = pendingCount;
        });
    }

    window.openReportModal = function(reportId = null) {
        document.getElementById('reportModal').classList.add('active');
        document.getElementById('reportModal').classList.remove('hidden');
        document.getElementById('reportId').value = reportId || '';

        if (reportId) {
            onValue(ref(db, `reports/${reportId}`), (snapshot) => {
                const report = snapshot.val();
                if (report) {
                    document.getElementById('reportUser').value = report.reportedUser || '';
                    document.getElementById('reportCategory').value = report.category || 'Behavior';
                    document.getElementById('reportDescription').value = report.description || '';
                    document.getElementById('reportStatus').value = report.status || 'Pending';
                }
            }, { onlyOnce: true });
        } else {
            document.getElementById('reportUser').value = '';
            document.getElementById('reportCategory').value = 'Behavior';
            document.getElementById('reportDescription').value = '';
            document.getElementById('reportStatus').value = 'Pending';
        }
    }

    window.closeReportModal = function() {
        document.getElementById('reportModal').classList.remove('active');
        document.getElementById('reportModal').classList.add('hidden');
    }

    window.saveReport = function() {
        const reportId = document.getElementById('reportId').value;
        const reportedUser = document.getElementById('reportUser').value;
        const category = document.getElementById('reportCategory').value;
        const description = document.getElementById('reportDescription').value;
        const status = document.getElementById('reportStatus').value;

        if (!reportedUser || !description) {
            alert('Please fill in all required fields');
            return;
        }

        const reportData = {
            reportedUser,
            category,
            description,
            status,
            updatedAt: new Date().toISOString() // Use ISO string for consistency
        };

        if (reportId) {
            update(ref(db, `reports/${reportId}`), reportData)
                .then(() => {
                    alert('Report updated successfully!');
                    window.closeReportModal();
                    window.loadReports();
                })
                .catch(error => alert('Error updating report: ' + error.message));
        } else {
            // For new reports, add timestamp and reporter info (if admin is logged in)
            reportData.timestamp = new Date().toISOString(); // Use ISO string
            // In a real admin panel, you might want to get the admin's UID/Name
            // For simplicity, we'll just add a placeholder or leave it out if not available
            reportData.reporterId = auth.currentUser ? auth.currentUser.uid : 'admin_unknown';
            reportData.reporterName = auth.currentUser ? auth.currentUser.email : 'Admin';

            push(reportsRef, reportData)
                .then(() => {
                    alert('Report submitted successfully!');
                    window.closeReportModal();
                    window.loadReports();
                })
                .catch(error => alert('Error submitting report: ' + error.message));
        }
    }

    window.deleteReport = function(reportId) {
        if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
            remove(ref(db, `reports/${reportId}`))
                .then(() => {
                    alert('Report deleted successfully!');
                    window.loadReports();
                })
                .catch(error => alert('Error deleting report: ' + error.message));
        }
    }

    function formatTime(isoString) {
        if (!isoString) return 'Unknown time';
        const date = new Date(isoString);
        return date.toLocaleString();
    }


    // --- Authentication and UI Control ---
    function adminLogin() {
      const email = document.getElementById("adminEmail").value.trim();
      const password = document.getElementById("adminPassword").value.trim();
      const statusEl = document.getElementById("status");

      if (!email || !password) {
        statusEl.innerText = "Email dan password tidak boleh kosong!";
        return;
      }

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          statusEl.innerText = "Login berhasil!";
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardLayout").classList.remove("hidden");
          loadInitialData(); // Load all data after successful login
        })
        .catch((error) => {
          statusEl.innerText = "Gagal login: " + error.message;
        });
    }

    window.addAccount = function() {
      const email = document.getElementById("email").value.trim();
      const defaultPassword = "123456"; // Default password for new accounts
      const status = document.getElementById("panelStatus");

      if (!email) {
        status.innerText = "❌ Email tidak boleh kosong!";
        return;
      }

      createUserWithEmailAndPassword(auth, email, defaultPassword)
        .then((userCredential) => {
          const uid = userCredential.user.uid;
          // Save user data to 'users' and 'moderators' nodes
          const userData = {
              name: email.split('@')[0], // Default name from email
              role: 'Member', // Default role
              subDivision: '',
              profileComplete: false, // Mark as incomplete for first login setup
              joinedAt: new Date().toISOString(),
              lastSeen: new Date().toISOString()
          };
          update(ref(db, `users/${uid}`), userData); // Use update to avoid overwriting if user exists
          update(ref(db, `moderators/${uid}`), userData); // Use update

          status.innerText = `✅ Email "${email}" berhasil ditambahkan! Password default: ${defaultPassword}`;
          document.getElementById("email").disabled = true;
          document.getElementById("resetBtn").classList.remove("hidden");
        })
        .catch((error) => {
          status.innerText = "❌ Gagal tambah akun: " + error.message;
        });
    };

    window.logout = function() {
      signOut(auth).then(() => {
        location.reload(); // Reload page after logout
      });
    };

    window.showSection = function(section) {
      const sections = ['dashboardSection', 'financeSection', 'moderatorSection', 'tambahAkunSection', 'eventsSection', 'reportsSection']; // Added reportsSection
      sections.forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(section + 'Section').classList.remove('hidden');

      // Load data specific to the section when shown
      if (section === 'finance') {
          loadFinance();
      } else if (section === 'moderator') {
          loadModerators();
      } else if (section === 'events') {
          loadEventsSummary();
      } else if (section === 'reports') { // NEW: Load reports when reports section is active
          window.loadReports();
      } else if (section === 'dashboard') {
          loadFinance();
          loadModerators();
          loadEventsSummary();
          // No reports chart on dashboard for now, but could be added
      }
    };

    window.resetForm = function() {
      document.getElementById("email").value = "";
      document.getElementById("email").disabled = false;
      document.getElementById("panelStatus").innerText = "";
      document.getElementById("resetBtn").classList.add("hidden");
    };

    window.toggleSidebar = function() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("hidden");
    };

    function filterModerators() {
      const keyword = document.getElementById("searchModerator").value.toLowerCase();
      const department = document.getElementById("filterDepartemen").value;

      document.querySelectorAll("#moderatorList .moderator-card").forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const dept = card.dataset.departemen;
        const matchName = name.includes(keyword);
        const matchDept = !department || dept === department;
        card.style.display = matchName && matchDept ? "" : "none";
      });
    }

    // Initial data load after successful login or on page load if already authenticated
    function loadInitialData() {
        loadFinance();
        loadModerators();
        loadEventsSummary();
        // No reports loaded initially for dashboard, only when reports section is opened
        window.showSection('dashboard'); // Default to dashboard
    }

    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("searchModerator");
      const filterSelect = document.getElementById("filterDepartemen");
      const loginBtn = document.querySelector("button.bg-blue-600");
      const reportFilterSelect = document.getElementById('reportFilter'); // NEW

      if (searchInput && filterSelect) {
        searchInput.addEventListener("input", filterModerators);
        filterSelect.addEventListener("change", filterModerators);
      }

      if (loginBtn) {
        loginBtn.addEventListener("click", adminLogin);
      }

      if (reportFilterSelect) { // NEW: Add event listener for report filter
          reportFilterSelect.addEventListener('change', window.loadReports);
      }

      // Check auth state on page load
      auth.onAuthStateChanged(user => {
        if (user) {
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardLayout").classList.remove("hidden");
          loadInitialData();
        } else {
          document.getElementById("loginPage").classList.remove("hidden");
          document.getElementById("dashboardLayout").classList.add("hidden");
        }
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-center text-gray-700">Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email Admin" class="w-full p-3 border rounded-lg" required />
    <input type="password" id="adminPassword" placeholder="Password" class="w-full p-3 border rounded-lg" required />
    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Login</button>
    <p id="status" class="text-center text-sm text-gray-500"></p>
  </div>
</div>

<!-- DASHBOARD LAYOUT -->
<div id="dashboardLayout" class="hidden min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-white shadow flex items-center justify-between px-6 py-4">
    <h1 class="text-xl font-semibold text-gray-700">Community Service Admin</h1>
    <div class="flex items-center gap-4">
      <button onclick="window.toggleSidebar()" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">☰</button>
      <button onclick="window.logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-64 bg-white border-r shadow-md flex flex-col transition-all duration-300">
      <nav class="flex-1 p-6 space-y-2">
        <ul class="space-y-2">
          <li><button onclick="window.showSection('dashboard')" class="text-left w-full text-gray-700 hover:text-blue-600">📊 Dashboard</button></li>
          <li><button onclick="window.showSection('finance')" class="text-left w-full text-gray-700 hover:text-blue-600">💰 Keuangan</button></li>
          <li><button onclick="window.showSection('moderator')" class="text-left w-full text-gray-700 hover:text-blue-600">🧑‍💼 Moderator</button></li>
          <li><button onclick="window.showSection('events')" class="text-left w-full text-gray-700 hover:text-blue-600">🗓️ Events</button></li>
          <li><button onclick="window.showSection('reports')" class="text-left w-full text-gray-700 hover:text-blue-600">⚠️ Reports</button></li> <!-- NEW -->
          <li><button onclick="window.showSection('tambahAkun')" class="text-left w-full text-gray-700 hover:text-blue-600">➕ Tambah Akun</button></li>
        </ul>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-6 overflow-y-auto space-y-6">

      <!-- Dashboard Section -->
      <div id="dashboardSection">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Ringkasan</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-semibold text-gray-600 mb-2">Keuangan Bulanan</h3>
            <canvas id="financeChart"></canvas>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-semibold text-gray-600 mb-2">Distribusi Peran Moderator</h3>
            <canvas id="roleChart"></canvas>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-semibold text-gray-600 mb-2">Status Event</h3>
            <canvas id="eventsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Finance Section -->
      <div id="financeSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Detail Keuangan</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 shadow rounded-lg">
                <h3 class="text-sm font-medium text-gray-500">Total Saldo</h3>
                <p class="text-2xl font-semibold text-gray-900" id="totalBalance">Rp 0</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg">
                <h3 class="text-sm font-medium text-gray-500">Pemasukan Bulanan</h3>
                <p class="text-2xl font-semibold text-green-600" id="monthlyIncome">Rp 0</p>
            </div>
            <div class="bg-sm font-medium text-gray-500">Pengeluaran Bulanan</h3>
                <p class="text-2xl font-semibold text-red-600" id="monthlyExpenses">Rp 0</p>
            </div>
        </div>
        <h3 class="text-xl font-bold text-gray-700 mb-3">Daftar Transaksi</h3>
        <div class="space-y-2" id="transactionsList">
            <!-- Transactions will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- Moderator Section -->
      <div id="moderatorSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Data Moderator</h2>
        <input type="text" id="searchModerator" placeholder="Cari nama moderator..." class="w-full p-2 border rounded-lg mb-4"/>
        <select id="filterDepartemen" class="w-full p-2 border rounded-lg mb-4">
          <option value="">Semua Departemen</option>
          <option value="Founder">Founder</option>
          <option value="Co-Founder">Co-Founder</option>
          <option value="Education">Education</option>
          <option value="Moderation">Moderation</option>
          <option value="Events">Events</option>
          <option value="Creative">Creative</option>
          <option value="Technology">Technology</option>
          <option value="Finance">Finance</option>
          <option value="Lainnya">Lainnya</option>
        </select>
        <div id="moderatorList" class="space-y-2"></div>
      </div>

      <!-- Events Section -->
      <div id="eventsSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Daftar Events</h2>
        <div class="space-y-4" id="eventsSummaryList">
            <!-- Events will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsSection" class="hidden"> <!-- NEW -->
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Monitoring Laporan</h2>
        <div class="flex justify-between items-center mb-4">
            <div class="flex space-x-2">
                <select class="border border-gray-300 rounded-md px-3 py-2" id="reportFilter">
                    <option value="all">Semua Laporan</option>
                    <option value="Pending">Pending</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Ignored">Ignored</option>
                </select>
                <button class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center" onclick="window.openReportModal()">
                    <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                    </svg>
                    Laporan Baru
                </button>
            </div>
            <div class="text-sm text-gray-500">
                Laporan Pending: <span id="pendingReportCount" class="font-bold text-red-600">0</span>
            </div>
        </div>
        <div class="space-y-4" id="reportsList">
            <!-- Reports will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- Tambah Akun Section -->
      <div id="tambahAkunSection" class="hidden max-w-md bg-white p-6 rounded-lg shadow space-y-4">
        <h3 class="text-2xl font-semibold text-gray-700">Tambah Akun Baru</h3>
        <input type="email" id="email" placeholder="Email Baru" class="w-full p-3 border rounded-lg" />
        <button onclick="window.addAccount()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg">Tambah Akun</button>
        <button id="resetBtn" onclick="window.resetForm()" class="hidden w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg">Tambah Akun Lagi</button>
        <p id="panelStatus" class="text-center text-sm text-gray-500"></p>
      </div>

    </main>
  </div>
</div>

<!-- Edit Moderator Modal -->
<div id="editModeratorModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
        <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">Edit Moderator</h2>
        <input type="hidden" id="editModeratorUid">
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Nama Lengkap</label>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editModeratorName" type="text"/>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Departemen</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editModeratorRole" onchange="window.updateSubDivisions('editModeratorRole', 'editModeratorSubDivision')">
                <option value="">Pilih Departemen</option>
                <option value="Founder">Founder</option>
                <option value="Co-Founder">Co-Founder</option>
                <option value="Education">Education</option>
                <option value="Moderation">Moderation</option>
                <option value="Events">Events</option>
                <option value="Creative">Creative</option>
                <option value="Technology">Technology</option>
                <option value="Finance">Finance</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Sub-Divisi</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editModeratorSubDivision" disabled>
                <option value="">Pilih Sub-Divisi</option>
            </select>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" onclick="window.closeEditModeratorModal()">Batal</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onclick="window.saveModeratorChanges()">Simpan Perubahan</button>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-blue-700" id="detailEventTitle"></h2>
            <button class="text-gray-500 hover:text-gray-700" onclick="window.closeEventDetailsModal()">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <p class="text-gray-600 mb-4" id="detailEventDescription"></p>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <p class="text-sm font-medium text-gray-700">Budget:</p>
                <p class="text-gray-900" id="detailEstimatedBudget"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-700">Execution Date:</p>
                <p class="text-gray-900" id="detailExecutionDateTime"></p>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="font-medium text-gray-900 mb-2">Overall Progress: <span id="detailEventProgress">0%</span></h3>
            <div class="progress-bar">
                <div class="progress-fill bg-blue-500" id="detailEventProgressBar" style="width: 0%;"></div>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-3">Departments Involved</h3>
        <div id="eventDetailsDepartmentsList" class="space-y-4">
            <!-- Departments, Subdivisions, and Tasks will be loaded here -->
        </div>
    </div>
</div>

<!-- Add/Edit Report Modal -->
<div id="reportModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
        <h2 class="text-xl font-bold text-purple-700 mb-4">Laporan Baru / Edit Laporan</h2>
        <input type="hidden" id="reportId">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">User Dilaporkan</label>
                <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportUser" placeholder="Username atau ID" type="text"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportCategory">
                    <option value="Behavior">Perilaku Tidak Pantas</option>
                    <option value="Spam">Spam</option>
                    <option value="Harassment">Pelecehan</option>
                    <option value="Scam">Penipuan</option>
                    <option value="Other">Lainnya</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                <textarea class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportDescription" placeholder="Berikan informasi detail tentang masalah..." rows="4"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportStatus">
                    <option value="Pending">Pending</option>
                    <option value="Resolved">Selesai</option>
                    <option value="Ignored">Diabaikan</option>
                </select>
            </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" onclick="window.closeReportModal()">Batal</button>
            <button class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700" onclick="window.saveReport()">Simpan Laporan</button>
        </div>
    </div>
</div>

</body>
</html>
