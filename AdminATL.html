<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | Community Service</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for modals and progress bars */
    .modal {
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease-in-out;
    }
    .modal.active {
        opacity: 1;
        visibility: visible;
    }
    .progress-bar {
        height: 8px;
        border-radius: 4px;
        background-color: #e0e0e0;
    }
    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    .nested-progress-container {
        margin-left: 1rem;
        border-left: 2px solid #e0e0e0;
        padding-left: 1rem;
    }
    .department-item, .subdivision-item {
        background-color: #f9fafb;
        padding: 0.75rem;
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .task-item {
        background-color: #ffffff;
        padding: 0.5rem;
        border-radius: 0.375rem;
        margin-bottom: 0.25rem;
        border: 1px solid #e5e7eb;
    }
  </style>
  <script type="module">
    // Firebase Finance Integration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue, update, push, remove, query, orderByChild, equalTo, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"; // Added 'set'

    const firebaseConfig = {
      apiKey: "AIzaSyCdl3XJ-eUz8BELLaSOXeZFpg7FLDFk7l4",
      authDomain: "community-service-f4540.firebaseapp.com",
      databaseURL: "https://community-service-f4540-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "community-service-f4540",
      storageBucket: "community-service-f4540.appspot.com",
      messagingSenderId: "610712310542",
      appId: "1:610712310542:web:12536a7c23d0b41db03d5f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Firebase References (disesuaikan dengan code (8).html)
    const usersRef = ref(db, 'users');
    const moderatorsRef = ref(db, 'moderators');
    const eventsRef = ref(db, 'events');
    const transactionsRef = ref(db, 'transactions');
    const statusRef = ref(db, 'status'); // Untuk status online/offline
    const reportsRef = ref(db, 'reports'); // NEW: For reports monitoring
    const ticketsRef = ref(db, 'tickets'); // NEW: For ticketing monitoring

    // Role and Sub-Division Options (from code (8).html)
    const roleColors = {
        "Founder": "red",
        "Co-Founder": "orange",
        "Education": "indigo",
        "Moderation": "blue",
        "Events": "green",
        "Creative": "purple",
        "Technology": "teal",
        "Finance": "yellow",
        "Public Relations": "pink" // NEW: Added Public Relations
    };

    const subDivisionOptions = {
        "Education": ["Koordinator Edukasi", "Mentor", "Pemateri", "Notulen"],
        "Moderation": ["Head Moderator", "Moderator", "Helper", "Support Staff"],
        "Events": ["Event Coordinator", "MC", "Host", "Giveaway Staff"],
        "Creative": ["Content Lead", "Designer", "Editor", "Dokumentator", "Social Media"],
        "Technology": ["Tech Lead", "Bot Developer", "Web Tools Support", "Database Admin"],
        "Finance": ["Bendahara", "Pembukuan", "Donasi", "Anggaran", "Laporan Keuangan"],
        "Public Relations": ["Partnership Manager", "Community Liaison", "Announcement Staff"] // NEW: Added Public Relations subdivisions
    };

    // Chart Instances
    let financeChartInstance = null;
    let roleChartInstance = null;
    let eventsChartInstance = null;
    let reportsChartInstance = null; // NEW: For reports chart
    let ticketsChartInstance = null; // NEW: For tickets chart

    // --- Finance Functions ---
    function loadFinance() {
      const transactionsList = document.getElementById('transactionsList');
      const totalBalanceEl = document.getElementById('totalBalance');
      const monthlyIncomeEl = document.getElementById('monthlyIncome');
      const monthlyExpensesEl = document.getElementById('monthlyExpenses');
      const totalBalanceDashboardEl = document.getElementById('totalBalanceDashboard'); // NEW

      onValue(transactionsRef, snapshot => {
        const transactions = snapshot.val();
        if (!transactions) {
          transactionsList.innerHTML = '<p class="text-center py-8 text-gray-500">No transactions yet</p>';
          totalBalanceEl.textContent = 'Rp 0';
          monthlyIncomeEl.textContent = 'Rp 0';
          monthlyExpensesEl.textContent = 'Rp 0';
          totalBalanceDashboardEl.textContent = 'Rp 0'; // NEW
          return;
        }

        const now = new Date();
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();

        let html = '';
        let balance = 0;
        let income = 0;
        let expenses = 0;

        // Sort transactions by date (newest first)
        const sortedTransactions = Object.entries(transactions).sort((a, b) => {
            const dateA = new Date(a[1].date);
            const dateB = new Date(b[1].date);
            return dateB - dateA;
        });

        sortedTransactions.forEach(([id, trx]) => {
          const trxDate = new Date(trx.date);
          const amount = parseInt(trx.amount) || 0;
          const isIncome = trx.type === 'income';

          if (isIncome) balance += amount;
          else balance -= amount;

          if (trxDate.getMonth() === thisMonth && trxDate.getFullYear() === thisYear) {
            if (isIncome) income += amount;
            else expenses += amount;
          }

          html += `
            <div class="bg-white p-4 shadow rounded-md flex justify-between items-center">
              <div>
                <h4 class="font-medium text-gray-900">${trx.description}</h4>
                <p class="text-sm text-gray-500">${trx.category} â€¢ ${trx.date}</p>
              </div>
              <div class="text-${isIncome ? 'green' : 'red'}-600 font-bold">
                ${isIncome ? '+' : '-'}Rp ${amount.toLocaleString()}
              </div>
            </div>
          `;
        });

        transactionsList.innerHTML = html;
        totalBalanceEl.textContent = `Rp ${balance.toLocaleString()}`;
        monthlyIncomeEl.textContent = `Rp ${income.toLocaleString()}`;
        monthlyExpensesEl.textContent = `Rp ${expenses.toLocaleString()}`;
        totalBalanceDashboardEl.textContent = `Rp ${balance.toLocaleString()}`; // NEW: Update dashboard stat

        // Update Finance Chart (Dashboard)
        updateFinanceChart(income, expenses);
      });
    }

    function updateFinanceChart(income, expenses) {
        const financeCtx = document.getElementById('financeChart').getContext('2d');
        if (financeChartInstance) {
            financeChartInstance.destroy();
        }
        financeChartInstance = new Chart(financeCtx, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expenses'],
                datasets: [{
                    label: 'Monthly Overview',
                    data: [income, expenses],
                    backgroundColor: ['#10b981', '#ef4444'], // green for income, red for expenses
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // NEW: Function to add a financial transaction
    function addTransaction(description, amount, type, category) {
        const newTransactionRef = push(transactionsRef);
        set(newTransactionRef, {
            description: description,
            amount: amount,
            type: type,
            category: category,
            date: new Date().toISOString().split('T')[0] // Format YYYY-MM-DD
        })
        .then(() => {
            console.log("Transaksi keuangan berhasil ditambahkan!");
            loadFinance(); // Reload finance data to update dashboard
        })
        .catch(error => {
            console.error("Gagal menambahkan transaksi keuangan:", error);
        });
    }


    // --- Moderator Functions ---
    function loadModerators() {
      const roles = {};
      const listContainer = document.getElementById("moderatorList");
      const activeModeratorCountEl = document.getElementById('activeModeratorCount'); // NEW
      listContainer.innerHTML = "";

      onValue(moderatorsRef, (snapshot) => {
        const moderators = snapshot.val();
        if (!moderators) {
            listContainer.innerHTML = '<p class="text-center py-8 text-gray-500">No moderators found</p>';
            if (roleChartInstance) roleChartInstance.destroy();
            activeModeratorCountEl.textContent = '0'; // NEW
            return;
        }

        // Clear previous roles data
        for (const key in roles) { delete roles[key]; }

        const moderatorArray = Object.entries(moderators);
        let onlineModeratorCount = 0; // NEW

        // Fetch status for each moderator
        const moderatorCardsPromises = moderatorArray.map(([id, mod]) => {
            return new Promise(resolve => {
                onValue(ref(db, `status/${id}`), (statusSnap) => {
                    const status = statusSnap.val();
                    const isOnline = status && status.status === 'online';
                    if (isOnline) onlineModeratorCount++; // NEW
                    resolve({ id, mod, isOnline });
                }, { onlyOnce: true }); // Use onlyOnce to avoid re-rendering on every status change
            });
        });

        Promise.all(moderatorCardsPromises).then(moderatorData => {
            listContainer.innerHTML = ""; // Clear list before re-populating

            moderatorData.forEach(({ id, mod, isOnline }) => {
                const role = mod.role || 'Lainnya';
                roles[role] = (roles[role] || 0) + 1;

                const statusColor = isOnline ? 'green' : 'gray';
                const statusText = isOnline ? 'Online' : 'Offline';

                const div = document.createElement("div");
                div.className = `p-4 bg-white rounded-lg shadow moderator-card relative`;
                div.dataset.name = mod.name || "Unknown";
                div.dataset.departemen = mod.role || "Unknown";
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full bg-${statusColor}-100 flex items-center justify-center font-bold text-${statusColor}-600 mr-3">
                                ${mod.name ? mod.name.substring(0, 1).toUpperCase() : '?'}
                            </div>
                            <div>
                                <strong class="text-gray-800">${mod.name || 'Unknown'}</strong><br>
                                <small class="text-gray-600">${mod.role || 'Member'} ${mod.subDivision ? ' - ' + mod.subDivision : ''}</small><br>
                                <span class="text-xs text-${statusColor}-500">${statusText}</span>
                            </div>
                        </div>
                        <button onclick="window.openEditModeratorModal('${id}', '${mod.name}', '${mod.role}', '${mod.subDivision}')" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Edit</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });

            activeModeratorCountEl.textContent = onlineModeratorCount; // NEW: Update dashboard stat

            // Update Role Chart (Dashboard)
            const roleCtx = document.getElementById('roleChart').getContext('2d');
            if (roleChartInstance) {
                roleChartInstance.destroy();
            }
            roleChartInstance = new Chart(roleCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(roles),
                    datasets: [{
                        data: Object.values(roles),
                        backgroundColor: ['#3b82f6', '#6366f1', '#facc15', '#10b981', '#f472b6', '#8b5cf6', '#06b6d4', '#f97316', '#f472b6'] // NEW: Added color for Public Relations
                    }]
                },
                options: { responsive: true }
            });
        });
      });
    }

    // --- Edit Moderator Modal Functions ---
    window.openEditModeratorModal = function(uid, name, role, subDivision) {
        document.getElementById('editModeratorModal').classList.add('active');
        document.getElementById('editModeratorModal').classList.remove('hidden');
        document.getElementById('editModeratorUid').value = uid;
        document.getElementById('editModeratorName').value = name;
        document.getElementById('editModeratorRole').value = role;

        // Populate sub-division dropdown based on selected role
        window.updateSubDivisions('editModeratorRole', 'editModeratorSubDivision', subDivision);
    }

    window.closeEditModeratorModal = function() {
        document.getElementById('editModeratorModal').classList.remove('active');
        document.getElementById('editModeratorModal').classList.add('hidden');
    }

    window.saveModeratorChanges = function() {
        const uid = document.getElementById('editModeratorUid').value;
        const name = document.getElementById('editModeratorName').value;
        const role = document.getElementById('editModeratorRole').value;
        const subDivision = document.getElementById('editModeratorSubDivision').value;

        if (!name || !role) {
            alert('Nama dan Departemen tidak boleh kosong!');
            return;
        }

        const updates = {
            name: name,
            role: role,
            subDivision: subDivision
        };

        // Update both users and moderators nodes
        update(ref(db, `users/${uid}`), updates)
            .then(() => update(ref(db, `moderators/${uid}`), updates))
            .then(() => {
                alert('Perubahan moderator berhasil disimpan!');
                window.closeEditModeratorModal();
                loadModerators(); // Reload moderator list to reflect changes
            })
            .catch(error => {
                alert('Gagal menyimpan perubahan: ' + error.message);
            });
    }

    // Function to update sub-division dropdown based on role selection
    window.updateSubDivisions = function(roleSelectId, subDivSelectId, initialValue = '') {
        const role = document.getElementById(roleSelectId).value;
        const subDiv = document.getElementById(subDivSelectId);

        subDiv.innerHTML = '<option value="">Pilih Sub-Divisi</option>'; // Clear existing options

        if (role === "Founder" || role === "Co-Founder" || role === "") {
            subDiv.value = "";
            subDiv.disabled = true;
            return;
        }

        const availableSubdivisions = subDivisionOptions[role] || [];
        availableSubdivisions.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            subDiv.appendChild(option);
        });

        subDiv.disabled = false;

        // Set initial value if provided
        if (initialValue) {
            subDiv.value = initialValue;
        } else {
            subDiv.value = ""; // Reset if no matching sub-division
        }
    }

    // --- Event/Task Functions ---
    function loadEventsSummary() {
        const eventsSummaryList = document.getElementById('eventsSummaryList');
        const upcomingEventCountEl = document.getElementById('upcomingEventCount'); // NEW
        eventsSummaryList.innerHTML = '<p class="text-center py-8 text-gray-500">Loading events...</p>';

        onValue(eventsRef, (snapshot) => {
            const events = snapshot.val();
            if (!events) {
                eventsSummaryList.innerHTML = '<p class="text-center py-8 text-gray-500">No events found</p>';
                if (eventsChartInstance) eventsChartInstance.destroy();
                upcomingEventCountEl.textContent = '0'; // NEW
                return;
            }

            let html = '';
            let totalEvents = 0;
            let completedEvents = 0;
            let inProgressEvents = 0;
            let upcomingEvents = 0; // NEW

            Object.entries(events).forEach(([id, event]) => {
                totalEvents++;
                const progress = event.progress ? (event.progress * 100).toFixed(0) : 0;
                const progressColor = progress == 100 ? 'green' : 'blue';

                if (progress == 100) completedEvents++;
                else if (progress > 0 && progress < 100) inProgressEvents++;
                else upcomingEvents++; // NEW: If progress is 0, consider it upcoming/not started

                html += `
                    <div class="bg-white p-4 rounded-lg shadow cursor-pointer hover:bg-gray-50" onclick="window.openEventDetailsModal('${id}')">
                        <h4 class="font-medium text-gray-900">${event.title}</h4>
                        <p class="text-sm text-gray-500">Date: ${new Date(event.executionDateTime).toLocaleDateString()}</p>
                        <div class="mt-2">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-${progressColor}-800">Progress: ${progress}%</span>
                            </div>
                            <div class="progress-bar h-2 bg-gray-200 rounded-full">
                                <div class="progress-fill h-full bg-${progressColor}-500 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            eventsSummaryList.innerHTML = html;
            upcomingEventCountEl.textContent = upcomingEvents; // NEW: Update dashboard stat

            // Update Events Chart (Dashboard)
            const eventsCtx = document.getElementById('eventsChart').getContext('2d');
            if (eventsChartInstance) {
                eventsChartInstance.destroy();
            }
            eventsChartInstance = new Chart(eventsCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [completedEvents, inProgressEvents, totalEvents - completedEvents - inProgressEvents],
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444'], // green, blue, red
                    }]
                },
                options: { responsive: true }
            });
        });
    }

    // --- Event Details Modal Functions ---
    let currentEventDetailsListener = null; // To store the listener for detachment

    window.openEventDetailsModal = function(eventId) {
        document.getElementById('eventDetailsModal').classList.add('active');
        document.getElementById('eventDetailsModal').classList.remove('hidden');

        // Detach previous listener if any
        if (currentEventDetailsListener) {
            off(ref(db, `events/${document.getElementById('eventDetailsModal').dataset.currentEventId}`), currentEventDetailsListener);
        }

        // Store current eventId
        document.getElementById('eventDetailsModal').dataset.currentEventId = eventId;

        // Attach new listener
        currentEventDetailsListener = onValue(ref(db, `events/${eventId}`), (snapshot) => {
            const event = snapshot.val();
            if (!event) {
                alert('Event not found.');
                window.closeEventDetailsModal();
                return;
            }

            document.getElementById('detailEventTitle').textContent = event.title;
            document.getElementById('detailEventDescription').textContent = event.description;
            document.getElementById('detailEstimatedBudget').textContent = `Rp ${event.estimatedBudget ? event.estimatedBudget.toLocaleString() : '0'}`;
            document.getElementById('detailExecutionDateTime').textContent = new Date(event.executionDateTime).toLocaleString();

            const overallProgress = event.progress ? (event.progress * 100).toFixed(0) : 0;
            document.getElementById('detailEventProgress').textContent = `${overallProgress}%`;
            document.getElementById('detailEventProgressBar').style.width = `${overallProgress}%`;
            document.getElementById('detailEventProgressBar').className = `progress-fill bg-${overallProgress == 100 ? 'green' : 'blue'}-500`;

            const departmentsListEl = document.getElementById('eventDetailsDepartmentsList');
            departmentsListEl.innerHTML = ''; // Clear previous content

            const departments = event.departments || {};
            for (const deptName of Object.keys(departments)) {
                const department = departments[deptName];
                const deptProgress = department.progress ? (department.progress * 100).toFixed(0) : 0;
                const deptProgressColor = deptProgress == 100 ? 'green' : 'blue';

                let departmentHtml = `
                    <div class="department-item">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-lg text-gray-800">${deptName}</h4>
                            <span class="text-sm font-medium text-${deptProgressColor}-800">${deptProgress}%</span>
                        </div>
                        <div class="progress-bar mb-3">
                            <div class="progress-fill bg-${deptProgressColor}-500" style="width: ${deptProgress}%"></div>
                        </div>
                        <div class="nested-progress-container space-y-3" id="subdivisions-list-${deptName}">
                            <!-- Subdivisions will be loaded here -->
                        </div>
                    </div>
                `;
                departmentsListEl.innerHTML += departmentHtml;

                const subdivisionsListEl = document.getElementById(`subdivisions-list-${deptName}`);
                const subdivisions = department.subdivisions || {};

                for (const subDivName of Object.keys(subdivisions)) {
                    const subdivision = subdivisions[subDivName];
                    const subDivProgress = subdivision.progress ? (subdivision.progress * 100).toFixed(0) : 0;
                    const subDivProgressColor = subDivProgress == 100 ? 'green' : 'blue';

                    let subdivisionHtml = `
                        <div class="subdivision-item">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium text-md text-gray-700">${subDivName}</h5>
                                <span class="text-sm font-medium text-${subDivProgressColor}-800">${subDivProgress}%</span>
                            </div>
                            <div class="progress-bar mb-3">
                                <div class="progress-fill bg-${subDivProgressColor}-500" style="width: ${subDivProgress}%"></div>
                            </div>
                            <div class="nested-progress-container space-y-2" id="tasks-list-${deptName}-${subDivName}">
                                <!-- Tasks will be loaded here -->
                            </div>
                        </div>
                    `;
                    subdivisionsListEl.innerHTML += subdivisionHtml;

                    const tasksListEl = document.getElementById(`tasks-list-${deptName}-${subDivName}`);
                    const tasks = subdivision.tasks || {};

                    for (const taskId of Object.keys(tasks)) {
                        const task = tasks[taskId];
                        const taskStatusColor = task.status === 'complete' ? 'green' : 'orange';

                        tasksListEl.innerHTML += `
                            <div class="task-item">
                                <div>
                                    <p class="font-normal text-gray-800">${task.title}</p>
                                    <p class="text-xs text-gray-500">PIC: ${task.PICName || 'Unknown'} | Status: <span class="font-medium text-${taskStatusColor}-600">${task.status}</span></p>
                                </div>
                            </div>
                        `;
                    }
                }
            }
        });
    }

    window.closeEventDetailsModal = function() {
        document.getElementById('eventDetailsModal').classList.remove('active');
        document.getElementById('eventDetailsModal').classList.add('hidden');
        // Detach listener when modal is closed to prevent memory leaks
        const currentEventId = document.getElementById('eventDetailsModal').dataset.currentEventId;
        if (currentEventId && currentEventDetailsListener) {
            off(ref(db, `events/${currentEventId}`), currentEventDetailsListener); // Detach listener
            currentEventDetailsListener = null; // Clear the stored listener
            delete document.getElementById('eventDetailsModal').dataset.currentEventId; // Clear stored ID
        }
    }

    // --- Reports Functions ---
    function updateReportsChart(pending, resolved, ignored) {
        const reportsCtx = document.getElementById('reportsChart').getContext('2d');
        if (reportsChartInstance) {
            reportsChartInstance.destroy();
        }
        reportsChartInstance = new Chart(reportsCtx, {
            type: 'doughnut', // Or 'bar', depending on preference
            data: {
                labels: ['Pending', 'Resolved', 'Ignored'],
                datasets: [{
                    data: [pending, resolved, ignored],
                    backgroundColor: ['#3b82f6', '#10b981', '#6b7280'], // blue, green, gray
                }]
            },
            options: { responsive: true }
        });
    }

    window.loadReports = function() {
        const reportsList = document.getElementById('reportsList');
        const pendingReportCountEl = document.getElementById('pendingReportCount');
        const pendingReportCountDashboardEl = document.getElementById('pendingReportCountDashboard'); // NEW
        reportsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

        const filter = document.getElementById('reportFilter').value;
        let reportsQuery = reportsRef;

        if (filter !== 'all') {
            reportsQuery = query(reportsRef, orderByChild('status'), equalTo(filter));
        } else {
            reportsQuery = query(reportsRef, orderByChild('timestamp')); // Order by timestamp for 'all'
        }

        onValue(reportsQuery, snapshot => {
            const reports = snapshot.val();
            if (!reports) {
                reportsList.innerHTML = '<p class="text-center py-8 text-gray-500">No reports found</p>';
                pendingReportCountEl.textContent = '0';
                pendingReportCountDashboardEl.textContent = '0'; // NEW
                if (reportsChartInstance) reportsChartInstance.destroy(); // Destroy chart if no data
                return;
            }

            let html = '';
            let pendingCount = 0;
            let resolvedCount = 0; // NEW
            let ignoredCount = 0; // NEW
            const reportArray = Object.entries(reports);

            // Sort reports by timestamp (newest first)
            reportArray.sort((a, b) => b[1].timestamp - a[1].timestamp);

            reportArray.forEach(([id, report]) => {
                if (report.status === 'Pending') pendingCount++;
                else if (report.status === 'Resolved') resolvedCount++; // NEW
                else if (report.status === 'Ignored') ignoredCount++; // NEW

                const categoryColor =
                    report.category === 'Behavior' ? 'red' :
                    report.category === 'Spam' ? 'orange' :
                    report.category === 'Harassment' ? 'purple' :
                    report.category === 'Scam' ? 'yellow' : 'gray';

                const statusColor =
                    report.status === 'Pending' ? 'blue' :
                    report.status === 'Resolved' ? 'green' : 'gray';

                html += `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900">Reported: ${report.reportedUser || 'Unknown'}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${categoryColor}-100 text-${categoryColor}-800">
                                        ${report.category}
                                    </span>
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                        ${report.status}
                                    </span>
                                    <span class="text-sm text-gray-500">${formatTime(report.timestamp)}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="window.openReportModal('${id}')" class="p-1 text-blue-600 hover:text-blue-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="window.deleteReport('${id}')" class="p-1 text-red-600 hover:text-red-800">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <p class="mt-3 text-gray-600">${report.description || 'No details provided'}</p>
                        ${report.reporterId ? `<p class="mt-2 text-sm text-gray-500">Reported by ${report.reporterName || 'unknown'}</p>` : ''}
                    </div>
                `;
            });

            reportsList.innerHTML = html;
            pendingReportCountEl.textContent = pendingCount;
            pendingReportCountDashboardEl.textContent = pendingCount; // NEW: Update dashboard stat

            // Update Reports Chart (Dashboard)
            updateReportsChart(pendingCount, resolvedCount, ignoredCount); // NEW
        });
    }

    window.openReportModal = function(reportId = null) {
        document.getElementById('reportModal').classList.add('active');
        document.getElementById('reportModal').classList.remove('hidden');
        document.getElementById('reportId').value = reportId || '';

        if (reportId) {
            onValue(ref(db, `reports/${reportId}`), (snapshot) => {
                const report = snapshot.val();
                if (report) {
                    document.getElementById('reportUser').value = report.reportedUser || '';
                    document.getElementById('reportCategory').value = report.category || 'Behavior';
                    document.getElementById('reportDescription').value = report.description || '';
                    document.getElementById('reportStatus').value = report.status || 'Pending';
                }
            }, { onlyOnce: true });
        } else {
            document.getElementById('reportUser').value = '';
            document.getElementById('reportCategory').value = 'Behavior';
            document.getElementById('reportDescription').value = '';
            document.getElementById('reportStatus').value = 'Pending';
        }
    }

    window.closeReportModal = function() {
        document.getElementById('reportModal').classList.remove('active');
        document.getElementById('reportModal').classList.add('hidden');
    }

    window.saveReport = function() {
        const reportId = document.getElementById('reportId').value;
        const reportedUser = document.getElementById('reportUser').value;
        const category = document.getElementById('reportCategory').value;
        const description = document.getElementById('reportDescription').value;
        const status = document.getElementById('reportStatus').value;

        if (!reportedUser || !description) {
            alert('Please fill in all required fields');
            return;
        }

        const reportData = {
            reportedUser,
            category,
            description,
            status,
            updatedAt: new Date().toISOString() // Use ISO string for consistency
        };

        if (reportId) {
            update(ref(db, `reports/${reportId}`), reportData)
                .then(() => {
                    alert('Report updated successfully!');
                    window.closeReportModal();
                    window.loadReports();
                })
                .catch(error => alert('Error updating report: ' + error.message));
        } else {
            // For new reports, add timestamp and reporter info (if admin is logged in)
            reportData.timestamp = new Date().toISOString(); // Use ISO string
            // In a real admin panel, you might want to get the admin's UID/Name
            // For simplicity, we'll just add a placeholder or leave it out if not available
            reportData.reporterId = auth.currentUser ? auth.currentUser.uid : 'admin_unknown';
            reportData.reporterName = auth.currentUser ? auth.currentUser.email : 'Admin';

            push(reportsRef, reportData)
                .then(() => {
                    alert('Report submitted successfully!');
                    window.closeReportModal();
                    window.loadReports();
                })
                .catch(error => alert('Error submitting report: ' + error.message));
        }
    }

    window.deleteReport = function(reportId) {
        if (confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
            remove(ref(db, `reports/${reportId}`))
                .then(() => {
                    alert('Report deleted successfully!');
                    window.loadReports();
                })
                .catch(error => alert('Error deleting report: ' + error.message));
        }
    }

    function formatTime(isoString) {
        if (!isoString) return 'Unknown time';
        const date = new Date(isoString);
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('en-US', options); // Example: "Oct 26, 2023, 10:30 AM"
    }

    // --- Ticketing Functions ---
    function updateTicketsChart(incomeTickets, expenseTickets, pending, completed, incomplete) { // MODIFIED: Added pending, completed, incomplete
        const ticketsCtx = document.getElementById('ticketsChart').getContext('2d');
        if (ticketsChartInstance) {
            ticketsChartInstance.destroy();
        }
        ticketsChartInstance = new Chart(ticketsCtx, {
            type: 'pie', // Changed to pie chart for status distribution
            data: {
                labels: ['Pending', 'Complete', 'Incomplete'], // NEW: Labels for status
                datasets: [{
                    label: 'Ticket Status Overview', // NEW: Label
                    data: [pending, completed, incomplete], // NEW: Data for status
                    backgroundColor: ['#3b82f6', '#10b981', '#ef4444'], // blue, green, red for status
                }]
            },
            options: {
                responsive: true,
                // Removed scales as they are not typically used for pie charts
            }
        });
    }

    window.loadTickets = function() {
        const ticketsList = document.getElementById('ticketsList');
        const totalTicketsCountEl = document.getElementById('totalTicketsCount');
        const totalTicketsCountDashboardEl = document.getElementById('totalTicketsCountDashboard');
        const pendingTicketsCountEl = document.getElementById('pendingTicketsCount'); // NEW: Element for pending count
        const completedTicketsCountEl = document.getElementById('completedTicketsCount'); // NEW: Element for completed count
        const incompleteTicketsCountEl = document.getElementById('incompleteTicketsCount'); // NEW: Element for incomplete count

        ticketsList.innerHTML = '<div class="flex items-center justify-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div></div>';

        onValue(ticketsRef, snapshot => {
            const tickets = snapshot.val();
            if (!tickets) {
                ticketsList.innerHTML = '<p class="text-center py-8 text-gray-500">No tickets found</p>';
                totalTicketsCountEl.textContent = '0';
                totalTicketsCountDashboardEl.textContent = '0';
                pendingTicketsCountEl.textContent = '0'; // NEW
                completedTicketsCountEl.textContent = '0'; // NEW
                incompleteTicketsCountEl.textContent = '0'; // NEW
                if (ticketsChartInstance) ticketsChartInstance.destroy();
                return;
            }

            let html = '';
            let totalCount = 0;
            let incomeTicketsValue = 0;
            let expenseTicketsValue = 0;
            let pendingTicketsCount = 0; // NEW
            let completedTicketsCount = 0; // NEW
            let incompleteTicketsCount = 0; // NEW

            const ticketArray = Object.entries(tickets);
            // Sort tickets by purchaseDate (newest first)
            ticketArray.sort((a, b) => new Date(b[1].purchaseDate) - new Date(a[1].purchaseDate));

            ticketArray.forEach(([id, ticket]) => {
                totalCount++;
                const isIncome = ticket.category === 'Income';
                const amount = parseInt(ticket.price) || 0;

                if (isIncome) incomeTicketsValue += amount;
                else expenseTicketsValue += amount;

                // NEW: Count based on status
                if (ticket.status === 'Pending') {
                    pendingTicketsCount++;
                } else if (ticket.status === 'Complete') {
                    completedTicketsCount++;
                } else if (ticket.status === 'Incomplete') {
                    incompleteTicketsCount++;
                }

                const categoryColor = isIncome ? 'green' : 'orange';
                const statusColor =
                    ticket.status === 'Pending' ? 'blue' :
                    ticket.status === 'Complete' ? 'green' :
                    ticket.status === 'Incomplete' ? 'red' : 'gray'; // NEW: Status color

                // Determine if buttons should be disabled
                const disableButtons = ticket.status === 'Complete' || ticket.status === 'Incomplete';
                const buttonClass = disableButtons ? 'opacity-50 cursor-not-allowed' : '';

                html += `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-medium text-gray-900">Buyer: ${ticket.buyerName || 'Unknown'}</h3>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${categoryColor}-100 text-${categoryColor}-800">
                                        ${ticket.category} - ${ticket.ticketType}
                                    </span>
                                    <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                        ${ticket.status || 'Pending'} <!-- NEW: Display status -->
                                    </span>
                                    <span class="text-sm text-gray-500">${ticket.purchaseDate}</span>
                                </div>
                            </div>
                            <div class="text-${isIncome ? 'green' : 'red'}-600 font-bold">
                                ${isIncome ? '+' : '-'}Rp ${amount.toLocaleString()}
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-3">
                            <button onclick="window.openTicketModal('${id}')" class="p-1 text-blue-600 hover:text-blue-800 ${buttonClass}" ${disableButtons ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="window.deleteTicket('${id}')" class="p-1 text-red-600 hover:text-red-800 ${buttonClass}" ${disableButtons ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                            </button>
                        </div>
                    </div>
                `;
            });

            ticketsList.innerHTML = html;
            totalTicketsCountEl.textContent = totalCount;
            totalTicketsCountDashboardEl.textContent = totalCount;
            pendingTicketsCountEl.textContent = pendingTicketsCount; // NEW
            completedTicketsCountEl.textContent = completedTicketsCount; // NEW
            incompleteTicketsCountEl.textContent = incompleteTicketsCount; // NEW

            // Update Tickets Chart (Dashboard)
            updateTicketsChart(incomeTicketsValue, expenseTicketsValue, pendingTicketsCount, completedTicketsCount, incompleteTicketsCount); // MODIFIED: Pass status counts
        });
    }

    window.openTicketModal = function(ticketId = null) {
        document.getElementById('ticketModal').classList.add('active');
        document.getElementById('ticketModal').classList.remove('hidden');
        document.getElementById('ticketId').value = ticketId || '';

        // Reset form fields
        document.getElementById('ticketBuyerName').value = '';
        document.getElementById('ticketCategory').value = '';
        document.getElementById('ticketType').innerHTML = '<option value="">Pilih Tipe Tiket</option>'; // Reset ticket types
        document.getElementById('ticketType').disabled = true;
        document.getElementById('ticketPurchaseDate').valueAsDate = new Date(); // Set to today's date
        document.getElementById('ticketPrice').value = '';
        document.getElementById('ticketStatus').value = 'Pending'; // NEW: Default status
        document.getElementById('saveTicketButton').disabled = false; // Enable save button by default

        // Get all input fields in the modal
        const formInputs = document.querySelectorAll('#ticketModal input, #ticketModal select, #ticketModal textarea, #saveTicketButton');

        if (ticketId) {
            onValue(ref(db, `tickets/${ticketId}`), (snapshot) => {
                const ticket = snapshot.val();
                if (ticket) {
                    document.getElementById('ticketBuyerName').value = ticket.buyerName || '';
                    document.getElementById('ticketCategory').value = ticket.category || '';
                    // Manually trigger updateTicketTypes to populate the correct options
                    window.updateTicketTypes('ticketCategory', 'ticketType', ticket.ticketType);
                    document.getElementById('ticketPurchaseDate').value = ticket.purchaseDate || '';
                    document.getElementById('ticketPrice').value = ticket.price || '';
                    document.getElementById('ticketStatus').value = ticket.status || 'Pending'; // NEW: Set status

                    // NEW: Disable inputs if status is Complete or Incomplete
                    const disableForm = ticket.status === 'Complete' || ticket.status === 'Incomplete';
                    formInputs.forEach(input => {
                        if (input.id !== 'ticketId') { // Don't disable the hidden ID field
                            input.disabled = disableForm;
                        }
                    });
                    document.getElementById('saveTicketButton').disabled = disableForm; // Disable save button
                }
            }, { onlyOnce: true });
        } else {
            // For new tickets, ensure inputs are enabled
            formInputs.forEach(input => {
                if (input.id !== 'ticketId') {
                    input.disabled = false;
                }
            });
        }
    }

    window.closeTicketModal = function() {
        document.getElementById('ticketModal').classList.remove('active');
        document.getElementById('ticketModal').classList.add('hidden');
    }

    window.saveTicket = function() {
        const ticketId = document.getElementById('ticketId').value;
        const buyerName = document.getElementById('ticketBuyerName').value;
        const category = document.getElementById('ticketCategory').value;
        const ticketType = document.getElementById('ticketType').value;
        const purchaseDate = document.getElementById('ticketPurchaseDate').value;
        const price = document.getElementById('ticketPrice').value;
        const status = document.getElementById('ticketStatus').value; // NEW: Get status

        if (!buyerName || !category || !ticketType || !purchaseDate || !price || !status) { // NEW: Validate status
            alert('Harap isi semua kolom yang diperlukan!');
            return;
        }

        // NEW: Check current status before saving if it's an existing ticket
        if (ticketId) {
            onValue(ref(db, `tickets/${ticketId}`), (snapshot) => {
                const currentTicket = snapshot.val();
                if (currentTicket && (currentTicket.status === 'Complete' || currentTicket.status === 'Incomplete')) {
                    alert('Tiket ini sudah selesai atau tidak lengkap dan tidak dapat diubah lagi.');
                    window.closeTicketModal();
                    return;
                }
                // If not complete/incomplete, proceed with saving
                performSaveTicket(ticketId, buyerName, category, ticketType, purchaseDate, price, status);
            }, { onlyOnce: true });
        } else {
            // For new tickets, directly save
            performSaveTicket(ticketId, buyerName, category, ticketType, purchaseDate, price, status);
        }
    }

    function performSaveTicket(ticketId, buyerName, category, ticketType, purchaseDate, price, status) {
        const ticketData = {
            buyerName,
            category,
            ticketType,
            purchaseDate,
            price: parseInt(price),
            status: status,
            updatedAt: new Date().toISOString()
        };

        if (ticketId) {
            // Get current ticket data to check status change
            onValue(ref(db, `tickets/${ticketId}`), (snapshot) => {
                const oldTicket = snapshot.val();
                const oldStatus = oldTicket ? oldTicket.status : '';

                update(ref(db, `tickets/${ticketId}`), ticketData)
                    .then(() => {
                        alert('Tiket berhasil diperbarui!');
                        window.closeTicketModal();
                        window.loadTickets();

                        // NEW: Check if status changed to 'Complete' and it's an Income ticket
                        if (oldStatus !== 'Complete' && status === 'Complete' && category === 'Income') {
                            addTransaction(`Pendapatan dari Tiket: ${buyerName} (${ticketType})`, price, 'income', 'Tiket');
                        }
                        // START MODIFICATION
                        // NEW: Check if status changed to 'Complete' and it's an Expense ticket
                        else if (oldStatus !== 'Complete' && status === 'Complete' && category === 'Expense') {
                            addTransaction(`Pengeluaran dari Tiket: ${buyerName} (${ticketType})`, price, 'expense', 'Tiket');
                        }
                        // END MODIFICATION
                    })
                    .catch(error => alert('Gagal memperbarui tiket: ' + error.message));
            }, { onlyOnce: true }); // Use onlyOnce to avoid re-triggering
        } else {
            ticketData.createdAt = new Date().toISOString();
            ticketData.status = 'Pending'; // Default status for new tickets
            push(ticketsRef, ticketData)
                .then(() => {
                    alert('Tiket berhasil ditambahkan!');
                    window.closeTicketModal();
                    window.loadTickets();
                    // NEW: If a new ticket is immediately set to 'Complete' (though default is Pending)
                    // This case is less likely with default Pending, but good to have.
                    if (ticketData.status === 'Complete' && ticketData.category === 'Income') {
                        addTransaction(`Pendapatan dari Tiket: ${buyerName} (${ticketType})`, price, 'income', 'Tiket');
                    }
                    // START MODIFICATION
                    // NEW: If a new ticket is immediately set to 'Complete' and it's an Expense ticket
                    else if (ticketData.status === 'Complete' && ticketData.category === 'Expense') {
                        addTransaction(`Pengeluaran dari Tiket: ${buyerName} (${ticketType})`, price, 'expense', 'Tiket');
                    }
                    // END MODIFICATION
                })
                .catch(error => alert('Gagal menambahkan tiket: ' + error.message));
        }
    }

    window.deleteTicket = function(ticketId) {
        if (confirm('Apakah Anda yakin ingin menghapus tiket ini? Tindakan ini tidak dapat dibatalkan.')) {
            // NEW: Check ticket status before allowing deletion
            onValue(ref(db, `tickets/${ticketId}`), (snapshot) => {
                const ticket = snapshot.val();
                if (ticket && (ticket.status === 'Complete' || ticket.status === 'Incomplete')) {
                    alert('Tiket ini sudah selesai atau tidak lengkap dan tidak dapat dihapus.');
                    return;
                }

                remove(ref(db, `tickets/${ticketId}`))
                    .then(() => {
                        alert('Tiket berhasil dihapus!');
                        window.loadTickets();
                    })
                    .catch(error => alert('Gagal menghapus tiket: ' + error.message));
            }, { onlyOnce: true });
        }
    }

    // Helper function to update ticket types based on category
    window.updateTicketTypes = function(categorySelectId, typeSelectId, initialValue = '') {
        const category = document.getElementById(categorySelectId).value;
        const ticketTypeSelect = document.getElementById(typeSelectId);

        ticketTypeSelect.innerHTML = '<option value="">Pilih Tipe Tiket</option>'; // Clear existing options

        let types = [];
        if (category === 'Income') {
            types = ['Donasi Umum', 'Sponsor Acara', 'Penjualan Merchandise', 'Tiket Event'];
        } else if (category === 'Expense') {
            types = ['Operasional', 'Acara', 'Gaji/Honor', 'Pemasaran', 'Lain-lain'];
        }

        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            ticketTypeSelect.appendChild(option);
        });

        ticketTypeSelect.disabled = types.length === 0;

        if (initialValue) {
            ticketTypeSelect.value = initialValue;
        } else {
            ticketTypeSelect.value = "";
        }
    }


    // --- Authentication and UI Control ---
    function adminLogin() {
      const email = document.getElementById("adminEmail").value.trim();
      const password = document.getElementById("adminPassword").value.trim();
      const statusEl = document.getElementById("status");

      if (!email || !password) {
        statusEl.innerText = "Email dan password tidak boleh kosong!";
        return;
      }

      // --- START MODIFICATION ---
      const allowedAdminEmail = "admin@atl.moderator.com";
      if (email !== allowedAdminEmail) {
        statusEl.innerText = "Akses ditolak: Hanya admin yang diizinkan untuk login.";
        return;
      }
      // --- END MODIFICATION ---

      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          statusEl.innerText = "Login berhasil!";
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardLayout").classList.remove("hidden");
          loadInitialData(); // Load all data after successful login
        })
        .catch((error) => {
          statusEl.innerText = "Gagal login: " + error.message;
        });
    }

    window.addAccount = function() {
      const email = document.getElementById("email").value.trim();
      const defaultPassword = "123456"; // Default password for new accounts
      const status = document.getElementById("panelStatus");

      if (!email) {
        status.innerText = "âŒ Email tidak boleh kosong!";
        return;
      }

      createUserWithEmailAndPassword(auth, email, defaultPassword)
        .then((userCredential) => {
          const uid = userCredential.user.uid;
          // Save user data to 'users' and 'moderators' nodes
          const userData = {
              name: email.split('@')[0], // Default name from email
              role: 'Member', // Default role
              subDivision: '',
              profileComplete: false, // Mark as incomplete for first login setup
              joinedAt: new Date().toISOString(),
              lastSeen: new Date().toISOString()
          };
          update(ref(db, `users/${uid}`), userData); // Use update to avoid overwriting if user exists
          update(ref(db, `moderators/${uid}`), userData); // Use update

          status.innerText = `âœ… Email "${email}" berhasil ditambahkan! Password default: ${defaultPassword}`;
          document.getElementById("email").disabled = true;
          document.getElementById("resetBtn").classList.remove("hidden");
        })
        .catch((error) => {
          status.innerText = "âŒ Gagal tambah akun: " + error.message;
        });
    };

    window.logout = function() {
      signOut(auth).then(() => {
        location.reload(); // Reload page after logout
      });
    };

    window.showSection = function(section) {
      const sections = ['dashboardSection', 'financeSection', 'moderatorSection', 'tambahAkunSection', 'eventsSection', 'reportsSection', 'ticketingSection']; // Added ticketingSection
      sections.forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(section + 'Section').classList.remove('hidden');

      // Load data specific to the section when shown
      if (section === 'finance') {
          loadFinance();
      } else if (section === 'moderator') {
          loadModerators();
      } else if (section === 'events') {
          loadEventsSummary();
      } else if (section === 'reports') {
          window.loadReports();
      } else if (section === 'ticketing') { // NEW: Load tickets when ticketing section is active
          window.loadTickets();
      } else if (section === 'dashboard') {
          loadFinance();
          loadModerators();
          loadEventsSummary();
          loadReports();
          loadTickets(); // Load tickets for dashboard chart
      }
    };

    window.resetForm = function() {
      document.getElementById("email").value = "";
      document.getElementById("email").disabled = false;
      document.getElementById("panelStatus").innerText = "";
      document.getElementById("resetBtn").classList.add("hidden");
    };

    window.toggleSidebar = function() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("hidden");
    };

    function filterModerators() {
      const keyword = document.getElementById("searchModerator").value.toLowerCase();
      const department = document.getElementById("filterDepartemen").value;

      document.querySelectorAll("#moderatorList .moderator-card").forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const dept = card.dataset.departemen;
        const matchName = name.includes(keyword);
        const matchDept = !department || dept === department;
        card.style.display = matchName && matchDept ? "" : "none";
      });
    }

    // Initial data load after successful login or on page load if already authenticated
    function loadInitialData() {
        loadFinance();
        loadModerators();
        loadEventsSummary();
        loadReports();
        loadTickets(); // NEW: Load tickets for dashboard chart
        window.showSection('dashboard'); // Default to dashboard
    }

    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("searchModerator");
      const filterSelect = document.getElementById("filterDepartemen");
      const loginBtn = document.querySelector("button.bg-blue-600");
      const reportFilterSelect = document.getElementById('reportFilter');
      const ticketCategorySelect = document.getElementById('ticketCategory'); // NEW

      if (searchInput && filterSelect) {
        searchInput.addEventListener("input", filterModerators);
        filterSelect.addEventListener("change", filterModerators);
      }

      if (loginBtn) {
        loginBtn.addEventListener("click", adminLogin);
      }

      if (reportFilterSelect) {
          reportFilterSelect.addEventListener('change', window.loadReports);
      }

      if (ticketCategorySelect) { // NEW: Add event listener for ticket category
          ticketCategorySelect.addEventListener('change', () => window.updateTicketTypes('ticketCategory', 'ticketType'));
      }

      // Check auth state on page load
      auth.onAuthStateChanged(user => {
        if (user) {
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboardLayout").classList.remove("hidden");
          loadInitialData();
        } else {
          document.getElementById("loginPage").classList.remove("hidden");
          document.getElementById("dashboardLayout").classList.add("hidden");
        }
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<!-- LOGIN PAGE -->
<div id="loginPage" class="flex items-center justify-center min-h-screen">
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md space-y-4">
    <h2 class="text-2xl font-bold text-center text-gray-700">Admin Login</h2>
    <input type="email" id="adminEmail" placeholder="Email Admin" class="w-full p-3 border rounded-lg" required />
    <input type="password" id="adminPassword" placeholder="Password" class="w-full p-3 border rounded-lg" required />
    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Login</button>
    <p id="status" class="text-center text-sm text-gray-500"></p>
  </div>
</div>

<!-- DASHBOARD LAYOUT -->
<div id="dashboardLayout" class="hidden min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-white shadow flex items-center justify-between px-6 py-4">
    <h1 class="text-xl font-semibold text-gray-700">Community Service Admin</h1>
    <div class="flex items-center gap-4">
      <button onclick="window.toggleSidebar()" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">â˜°</button>
      <button onclick="window.logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Logout</button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-64 bg-white border-r shadow-md flex flex-col transition-all duration-300">
      <nav class="flex-1 p-6 space-y-2">
        <ul class="space-y-2">
          <li><button onclick="window.showSection('dashboard')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">ðŸ“Š Dashboard</button></li>
          <li><button onclick="window.showSection('finance')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">ðŸ’° Keuangan</button></li>
          <li><button onclick="window.showSection('moderator')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">ðŸ§‘â€ðŸ’¼ Moderator</button></li>
          <li><button onclick="window.showSection('events')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">ðŸ—“ï¸ Events</button></li>
          <li><button onclick="window.showSection('reports')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">âš ï¸ Reports</button></li>
          <li><button onclick="window.showSection('ticketing')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">ðŸŽ« Tiketing</button></li> <!-- NEW -->
          <li><button onclick="window.showSection('tambahAkun')" class="text-left w-full text-gray-700 hover:text-blue-600 cursor-pointer">âž• Tambah Akun</button></li>
        </ul>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-6 overflow-y-auto space-y-6">

      <!-- Dashboard Section -->
      <div id="dashboardSection">
        <h2 class="text-2xl font-bold text-gray-700 mb-6">Ringkasan Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Quick Stats Cards -->
            <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Total Saldo</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="totalBalanceDashboard">Rp 0</p>
                </div>
                <div class="text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Moderator Aktif</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="activeModeratorCount">0</p>
                </div>
                <div class="text-green-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M12 20V10m0 0a4 4 0 01-4-4v-1a2 2 0 012-2h4a2 2 0 012 2v1a4 4 0 01-4 4z" />
                    </svg>
                </div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Events Mendatang</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="upcomingEventCount">0</p>
                </div>
                <div class="text-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
            </div>
            <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Laporan Pending</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="pendingReportCountDashboard">0</p>
                </div>
                <div class="text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
            </div>
            <!-- NEW: Total Tickets Card -->
            <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-medium text-gray-500">Total Tiket</h3>
                    <p class="text-2xl font-semibold text-gray-900" id="totalTicketsCountDashboard">0</p>
                </div>
                <div class="text-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M12 5a3 3 0 11-6 0 3 3 0 016 0zm6 0a3 3 0 11-6 0 3 3 0 016 0zM12 12a3 3 0 11-6 0 3 3 0 016 0zm6 0a3 3 0 11-6 0 3 3 0 016 0zM12 19a3 3 0 11-6 0 3 3 0 016 0zm6 0a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-semibold text-gray-700 mb-4">Keuangan Bulanan</h3>
            <canvas id="financeChart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-semibold text-gray-700 mb-4">Distribusi Peran Moderator</h3>
            <canvas id="roleChart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-semibold text-gray-700 mb-4">Status Event</h3>
            <canvas id="eventsChart"></canvas>
          </div>
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-semibold text-gray-700 mb-4">Status Laporan</h3>
            <canvas id="reportsChart"></canvas>
          </div>
          <!-- NEW: Tickets Chart -->
          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-semibold text-gray-700 mb-4">Overview Tiket</h3>
            <canvas id="ticketsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Finance Section -->
      <div id="financeSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Detail Keuangan</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 shadow rounded-lg">
                <h3 class="text-sm font-medium text-gray-500">Total Saldo</h3>
                <p class="text-2xl font-semibold text-gray-900" id="totalBalance">Rp 0</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg">
                <h3 class="text-sm font-medium text-gray-500">Pemasukan Bulanan</h3>
                <p class="text-2xl font-semibold text-green-600" id="monthlyIncome">Rp 0</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg"> <!-- Corrected div for monthly expenses -->
                <h3 class="text-sm font-medium text-gray-500">Pengeluaran Bulanan</h3>
                <p class="text-2xl font-semibold text-red-600" id="monthlyExpenses">Rp 0</p>
            </div>
        </div>
        <h3 class="text-xl font-bold text-gray-700 mb-3">Daftar Transaksi</h3>
        <div class="space-y-2" id="transactionsList">
            <!-- Transactions will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- Moderator Section -->
      <div id="moderatorSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Data Moderator</h2>
        <input type="text" id="searchModerator" placeholder="Cari nama moderator..." class="w-full p-2 border rounded-lg mb-4"/>
        <select id="filterDepartemen" class="w-full p-2 border rounded-lg mb-4">
          <option value="">Semua Departemen</option>
          <option value="Founder">Founder</option>
          <option value="Co-Founder">Co-Founder</option>
          <option value="Education">Education</option>
          <option value="Moderation">Moderation</option>
          <option value="Events">Events</option>
          <option value="Creative">Creative</option>
          <option value="Technology">Technology</option>
          <option value="Finance">Finance</option>
          <option value="Public Relations">Public Relations</option> <!-- NEW: Added Public Relations -->
          <option value="Lainnya">Lainnya</option>
        </select>
        <div id="moderatorList" class="space-y-2"></div>
      </div>

      <!-- Events Section -->
      <div id="eventsSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Daftar Events</h2>
        <div class="space-y-4" id="eventsSummaryList">
            <!-- Events will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reportsSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Monitoring Laporan</h2>
        <div class="flex justify-between items-center mb-4">
            <div class="flex space-x-2">
                <select class="border border-gray-300 rounded-md px-3 py-2" id="reportFilter">
                    <option value="all">Semua Laporan</option>
                    <option value="Pending">Pending</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Ignored">Ignored</option>
                </select>
                <button class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 flex items-center" onclick="window.openReportModal()">
                    <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                    </svg>
                    Laporan Baru
                </button>
            </div>
            <div class="text-sm text-gray-500">
                Laporan Pending: <span id="pendingReportCount" class="font-bold text-red-600">0</span>
            </div>
        </div>
        <div class="space-y-4" id="reportsList">
            <!-- Reports will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- NEW: Ticketing Section -->
      <div id="ticketingSection" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Monitoring Tiket</h2>
        <div class="flex justify-between items-center mb-4">
            <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center" onclick="window.openTicketModal()">
                <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
                Tambah Tiket Baru
            </button>
            <div class="text-sm text-gray-500 flex space-x-4">
                <span>Total Tiket: <span id="totalTicketsCount" class="font-bold text-blue-600">0</span></span>
                <span>Pending: <span id="pendingTicketsCount" class="font-bold text-blue-600">0</span></span>
                <span>Complete: <span id="completedTicketsCount" class="font-bold text-green-600">0</span></span>
                <span>Incomplete: <span id="incompleteTicketsCount" class="font-bold text-red-600">0</span></span>
            </div>
        </div>
        <div class="space-y-4" id="ticketsList">
            <!-- Tickets will be loaded here -->
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500"></div>
            </div>
        </div>
      </div>

      <!-- Tambah Akun Section -->
      <div id="tambahAkunSection" class="hidden max-w-md bg-white p-6 rounded-lg shadow space-y-4">
        <h3 class="text-2xl font-semibold text-gray-700">Tambah Akun Baru</h3>
        <input type="email" id="email" placeholder="Email Baru" class="w-full p-3 border rounded-lg" />
        <button onclick="window.addAccount()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg">Tambah Akun</button>
        <button id="resetBtn" onclick="window.resetForm()" class="hidden w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg">Tambah Akun Lagi</button>
        <p id="panelStatus" class="text-center text-sm text-gray-500"></p>
      </div>

    </main>
  </div>
</div>

<!-- Edit Moderator Modal -->
<div id="editModeratorModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
        <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">Edit Moderator</h2>
        <input type="hidden" id="editModeratorUid">
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Nama Lengkap</label>
            <input class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editModeratorName" type="text"/>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Departemen</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editModeratorRole" onchange="window.updateSubDivisions('editModeratorRole', 'editModeratorSubDivision')">
                <option value="">Pilih Departemen</option>
                <option value="Founder">Founder</option>
                <option value="Co-Founder">Co-Founder</option>
                <option value="Education">Education</option>
                <option value="Moderation">Moderation</option>
                <option value="Events">Events</option>
                <option value="Creative">Creative</option>
                <option value="Technology">Technology</option>
                <option value="Finance">Finance</option>
                <option value="Public Relations">Public Relations</option> <!-- NEW: Added Public Relations -->
            </select>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Sub-Divisi</label>
            <select class="w-full px-3 py-2 border border-gray-300 rounded-md" id="editModeratorSubDivision" disabled>
                <option value="">Pilih Sub-Divisi</option>
            </select>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" onclick="window.closeEditModeratorModal()">Batal</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onclick="window.saveModeratorChanges()">Simpan Perubahan</button>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-blue-700" id="detailEventTitle"></h2>
            <button class="text-gray-500 hover:text-gray-700" onclick="window.closeEventDetailsModal()">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <p class="text-gray-600 mb-4" id="detailEventDescription"></p>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
                <p class="text-sm font-medium text-gray-700">Budget:</p>
                <p class="text-gray-900" id="detailEstimatedBudget"></p>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-700">Execution Date:</p>
                <p class="text-gray-900" id="detailExecutionDateTime"></p>
            </div>
        </div>

        <div class="mb-4">
            <h3 class="font-medium text-gray-900 mb-2">Overall Progress: <span id="detailEventProgress">0%</span></h3>
            <div class="progress-bar">
                <div class="progress-fill bg-blue-500" id="detailEventProgressBar" style="width: 0%;"></div>
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-800 mb-3">Departments Involved</h3>
        <div id="eventDetailsDepartmentsList" class="space-y-4">
            <!-- Departments, Subdivisions, and Tasks will be loaded here -->
        </div>
    </div>
</div>

<!-- Add/Edit Report Modal -->
<div id="reportModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
        <h2 class="text-xl font-bold text-purple-700 mb-4">Laporan Baru / Edit Laporan</h2>
        <input type="hidden" id="reportId">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">User Dilaporkan</label>
                <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportUser" placeholder="Username atau ID" type="text"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportCategory">
                    <option value="Behavior">Perilaku Tidak Pantas</option>
                    <option value="Spam">Spam</option>
                    <option value="Harassment">Pelecehan</option>
                    <option value="Scam">Penipuan</option>
                    <option value="Other">Lainnya</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                <textarea class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportDescription" placeholder="Berikan informasi detail tentang masalah..." rows="4"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="reportStatus">
                    <option value="Pending">Pending</option>
                    <option value="Resolved">Selesai</option>
                    <option value="Ignored">Diabaikan</option>
                </select>
            </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" onclick="window.closeReportModal()">Batal</button>
            <button class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700" onclick="window.saveReport()">Simpan Laporan</button>
        </div>
    </div>
</div>

<!-- NEW: Add/Edit Ticket Modal -->
<div id="ticketModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md max-h-screen overflow-y-auto">
        <h2 class="text-xl font-bold text-blue-700 mb-4">Tambah / Edit Tiket</h2>
        <input type="hidden" id="ticketId">
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pembeli</label>
                <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="ticketBuyerName" type="text" placeholder="Nama Pembeli Tiket"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="ticketCategory" onchange="window.updateTicketTypes('ticketCategory', 'ticketType')">
                    <option value="">Pilih Kategori</option>
                    <option value="Income">Pemasukan</option>
                    <option value="Expense">Pengeluaran</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipe Tiket</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="ticketType" disabled>
                    <option value="">Pilih Tipe Tiket</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Pembelian</label>
                <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="ticketPurchaseDate" type="date"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
                <input class="w-full border border-gray-300 rounded-md px-3 py-2" id="ticketPrice" type="number" min="0"/>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status Tiket</label>
                <select class="w-full border border-gray-300 rounded-md px-3 py-2" id="ticketStatus">
                    <option value="Pending">Pending</option>
                    <option value="Complete">Complete</option>
                    <option value="Incomplete">Incomplete</option>
                </select>
            </div>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
            <button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100" onclick="window.closeTicketModal()">Batal</button>
            <button id="saveTicketButton" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" onclick="window.saveTicket()">Simpan Tiket</button>
        </div>
    </div>
</div>

</body>
</html>
